# ============================================================================
# TEST CONFIGURATION - Local Testing with Production Kafka
# ============================================================================
# Usage: mvn spring-boot:run -Dspring-boot.run.profiles=test
#
# Test Plan:
# 1. Connect to production Kafka (13.203.60.173:9094)
# 2. Use NEW consumer group (won't affect production lag)
# 3. Consume from existing topics: forwardtesting-data, Orderbook, OpenInterest
# 4. Produce to TEST topics (suffix: -test)
# 5. Verify candle formation locally
# ============================================================================

spring.application.name=consumer-test
server.port=8081

# ============================================================================
# PRODUCTION KAFKA CONNECTION
# ============================================================================
spring.kafka.bootstrap-servers=13.203.60.173:9094
spring.kafka.consumer.auto-offset-reset=earliest

# NEW CONSUMER GROUP for Friday data replay (v4 for fresh start)
spring.kafka.consumer.group-id=streaming-candle-FRIDAY-REPLAY-v4

# Consumer deserializer configuration
spring.kafka.consumer.key-deserializer=org.apache.kafka.common.serialization.StringDeserializer
spring.kafka.consumer.value-deserializer=org.springframework.kafka.support.serializer.JsonDeserializer
spring.kafka.consumer.properties.spring.json.trusted.packages=com.kotsin.consumer.model
spring.kafka.consumer.properties.spring.json.value.default.type=com.kotsin.consumer.model.TickData

# Producer configuration (for test topics)
spring.kafka.producer.key-serializer=org.apache.kafka.common.serialization.StringSerializer
spring.kafka.producer.value-serializer=org.springframework.kafka.support.serializer.JsonSerializer

# ============================================================================
# KAFKA STREAMS - TEST CONFIGURATION (Friday replay)
# ============================================================================
# CRITICAL: Using v4 for fresh consumer groups (previous runs used v3)
spring.kafka.streams.application-id=candle-processor-FRIDAY-v4
spring.kafka.streams.bootstrap-servers=13.203.60.173:9094
spring.kafka.streams.client-id=streamingcandle-test
spring.kafka.streams.properties.default.key.serde=org.apache.kafka.common.serialization.Serdes$StringSerde
spring.kafka.streams.properties.default.value.serde=org.springframework.kafka.support.serializer.JsonSerde
spring.kafka.streams.properties.spring.json.trusted.packages=com.kotsin.consumer.model
spring.kafka.streams.properties.auto.offset.reset=earliest

# Local state directory for testing
spring.kafka.streams.state-dir=/tmp/kstreams-test/${spring.application.name}
spring.kafka.streams.properties.processing.guarantee=exactly_once_v2

# Production reliability configurations
spring.kafka.streams.properties.commit.interval.ms=100
spring.kafka.streams.properties.statestore.cache.max.bytes=10485760
spring.kafka.streams.properties.session.timeout.ms=30000
spring.kafka.streams.properties.heartbeat.interval.ms=3000
spring.kafka.streams.properties.request.timeout.ms=40000
spring.kafka.streams.properties.retry.backoff.ms=100
spring.kafka.streams.properties.reconnect.backoff.ms=50

# Low latency configurations
spring.kafka.streams.properties.linger.ms=5
spring.kafka.streams.properties.batch.size=1024
spring.kafka.streams.properties.buffer.memory=33554432

spring.kafka.streams.properties.spring.json.value.default.type=com.kotsin.consumer.model.TickData

# ============================================================================
# LOCAL MONGODB (for testing)
# ============================================================================
spring.data.mongodb.uri=mongodb://localhost:27017/tradeIngestion-test
spring.data.mongodb.auto-index-creation=true

# ============================================================================
# INFORMATION-DRIVEN BARS - TEST TOPICS
# ============================================================================
information.bars.enabled=true
information.bars.thresholds=1.0,2.0,5.0
# CRITICAL: Use unique app ID prefix for test to avoid interfering with production consumer groups
# v2 for fresh consumer groups
information.bars.app.id.prefix=information-bars-FRIDAY-TEST-v2

# VIB - Volume Imbalance Bars
information.bars.vib.enabled=true
information.bars.vib.min.ticks=10
information.bars.vib.warmup.samples=20

# DIB - Dollar Imbalance Bars
information.bars.dib.enabled=true
information.bars.dib.min.ticks=10
information.bars.dib.warmup.samples=20

# TRB - Tick Runs Bars
information.bars.trb.enabled=true
information.bars.trb.min.ticks=10
information.bars.trb.warmup.samples=20

# VRB - Volume Runs Bars
information.bars.vrb.enabled=true
information.bars.vrb.min.ticks=10
information.bars.vrb.warmup.samples=20

# EWMA parameters
information.bars.ewma.span=100.0
information.bars.min.expected.volume=100.0
information.bars.expected.bar.size=50.0

# ============================================================================
# KAFKA TOPICS - TEST SUFFIX
# Input: Production topics (read-only, won't affect production lag)
# Output: Test topics (will be deleted after testing)
# ============================================================================

# INPUT TOPICS (from production Kafka)
information.bars.input.topic=forwardtesting-data

# OUTPUT TOPICS (test topics - for Friday replay)
information.bars.vib.output.topic=volume-imbalance-bars-friday
information.bars.dib.output.topic=dollar-imbalance-bars-friday
information.bars.trb.output.topic=tick-runs-bars-friday
information.bars.vrb.output.topic=volume-runs-bars-friday
candle.output.topic.1min=1-min-candle-friday
candle.output.topic.2min=2-min-candle-friday
candle.output.topic.3min=3-min-candle-friday
candle.output.topic.5min=5-min-candle-friday

# Also enable 15m and 30m candle outputs for test
candle.output.topic.15min=15-min-candle-friday
candle.output.topic.30min=30-min-candle-friday

# ============================================================================
# MICROSTRUCTURE FEATURES - TEST TOPICS
# ============================================================================
microstructure.enabled=true

# INPUT: Production Orderbook topic
microstructure.input.topic=Orderbook

# OUTPUT: Test topic (aligned with indicatorCalculator)
microstructure.output.topic=microstructure-features-friday

# Configuration
microstructure.window.size=50
microstructure.min.observations=20
microstructure.emit.interval.ms=1000

# ============================================================================
# OPEN INTEREST PROCESSING - TEST TOPICS
# ============================================================================
openinterest.enabled=true

# INPUT: Production OpenInterest topic
openinterest.input.topic=OpenInterest

# OUTPUT: Test topics (Friday replay)
openinterest.output.topic.1min=1-min-oi-friday
openinterest.output.topic.2min=2-min-oi-friday
openinterest.output.topic.3min=3-min-oi-friday
openinterest.output.topic.5min=5-min-oi-friday
openinterest.output.topic.15min=15-min-oi-friday
openinterest.output.topic.30min=30-min-oi-friday

# ============================================================================
# LOGGING (verbose for testing)
# ============================================================================
logging.level.com.kotsin=DEBUG
logging.level.org.apache.kafka=INFO
logging.level.org.springframework.kafka=DEBUG
