# ============================================================================
# STREAMINGCANDLE - END-TO-END PIPELINE CONFIGURATION
# ============================================================================
# Combined: NEW family candle pipeline + EXISTING strategy modules

spring.profiles.default=production
spring.application.name=streamingcandle
server.port=${SERVER_PORT:8081}

# ============================================================================
# KAFKA STREAMS CONFIGURATION
# ============================================================================
spring.kafka.bootstrap-servers=${KAFKA_BOOTSTRAP_SERVERS:13.203.60.173:9094}
spring.kafka.streams.application-id=${KAFKA_APP_ID:unified-family-processor-v2}
spring.kafka.streams.client-id=streamingcandle-family
spring.kafka.streams.state-dir=/tmp/kafka-streams/${spring.application.name}

# APP-ID PREFIX - Change this to replay data from earliest with new consumer groups
# Example: "replay-20251229-" creates groups like "replay-20251229-unified-instrument-candle-processor"
# Updated: 2026-01-04 19:38 - Changed to -v2 to force fresh consumption from earliest
# This creates NEW consumer groups that will start from the beginning of all topics
kafka.streams.app-id-prefix=v11-spread-enhanced-20260105-${KAFKA_APP_ID_PREFIX:comprehensive-logging-scriprepo-20260104-v2-}

# KAFKA CONSUMER GROUP IDS - Change suffix to replay data
# Add "-v2", "-v3" etc to force new consumer groups and replay from earliest
# Updated: 2026-01-04 22:59 - Changed to v10 to test 10/10
# Individual consumer groups
kafka.consumer.curated-group=curated-consumer-group-v11
kafka.consumer.mtis-group=mtis-consumer-group-v11
kafka.consumer.stats-group=stats-consumer-group-v11

# Serdes
spring.kafka.streams.properties.default.key.serde=org.apache.kafka.common.serialization.Serdes$StringSerde
spring.kafka.streams.properties.default.value.serde=org.springframework.kafka.support.serializer.JsonSerde
spring.kafka.streams.properties.spring.json.trusted.packages=com.kotsin.consumer.model,com.kotsin.consumer.domain.model

# Offset reset - consume from EARLIEST for testing with existing data
# This forces new consumer groups to start from the beginning of topics
spring.kafka.streams.properties.auto.offset.reset=earliest

# Processing guarantee
spring.kafka.streams.properties.processing.guarantee=at_least_once
spring.kafka.streams.properties.replication.factor=1

# Performance tuning
spring.kafka.streams.properties.commit.interval.ms=100
spring.kafka.streams.properties.statestore.cache.max.bytes=104857600
# Set to 20 threads to match DOUBLED Orderbook topic partitions (20 partitions)
# Each thread can process one partition in parallel - full parallelism achieved
# Partitions: forwardtesting-data=10, OpenInterest=6, Orderbook=20 (max)
spring.kafka.streams.properties.num.stream.threads=20
spring.kafka.streams.properties.session.timeout.ms=30000
spring.kafka.streams.properties.heartbeat.interval.ms=3000

# Exception handlers - skip bad records instead of crashing
spring.kafka.streams.properties.default.deserialization.exception.handler=org.apache.kafka.streams.errors.LogAndContinueExceptionHandler
spring.kafka.streams.properties.default.production.exception.handler=org.apache.kafka.streams.errors.LogAndContinueProductionExceptionHandler

# ============================================================================
# STAGE 1: INPUT TOPICS (Raw Data Sources)
# ============================================================================
input.topic.ticks=forwardtesting-data
input.topic.orderbook=Orderbook
input.topic.oi=OpenInterest

# ============================================================================
# STAGE 2: NEW UNIFIED INSTRUMENT CANDLE PROCESSOR
# ============================================================================
# Joins tick + orderbook + OI into InstrumentCandle
unified.processor.enabled=true
unified.input.topic.ticks=forwardtesting-data
unified.input.topic.orderbook=Orderbook
unified.input.topic.oi=OpenInterest
unified.output.topic.instrument=instrument-candle-1m
# INCREASED: 5s → 60s to handle processing lag and prevent expired window warnings
unified.window.grace.seconds=60

# Consumer fetch optimization for high-throughput orderbook consumption
# Optimized for Orderbook topic with 10 partitions
# Higher values = faster consumption, more memory usage
unified.processor.max.poll.records=2000
unified.processor.fetch.min.bytes=2097152
unified.processor.fetch.max.wait.ms=50

# ============================================================================
# STAGE 3: FAMILY CANDLE PROCESSOR
# ============================================================================
# Groups instruments into family candles
family.candle.processor.enabled=true
# INCREASED: 5s → 30s to handle processing lag and prevent expired window warnings
family.candle.window.grace.seconds=30
family.candle.cache.ttl.hours=24
family.cache.refresh.on.miss=true

# ============================================================================
# STAGE 4: TIMEFRAME AGGREGATOR
# ============================================================================
# Aggregates 1m -> higher timeframes
timeframe.aggregator.enabled=true

# Family candle output topics
family.output.topics.1m=family-candle-1m
family.output.topics.2m=family-candle-2m
family.output.topics.3m=family-candle-3m
family.output.topics.5m=family-candle-5m
family.output.topics.15m=family-candle-15m
family.output.topics.30m=family-candle-30m
family.output.topics.1h=family-candle-1h
family.output.topics.2h=family-candle-2h
family.output.topics.4h=family-candle-4h
family.output.topics.1d=family-candle-1d

# ============================================================================
# STRATEGY MODULES (Consume from family-candle-* topics)
# ============================================================================

# IPU Processor (Institutional Participation & Urgency)
ipu.enabled=true
ipu.exhaustion.threshold=0.7

# VCP Processor (Volume Cluster Profile)
vcp.enabled=true
vcp.cluster.min.volume.ratio=1.5

# REGIME PROCESSOR (Index and Security)
regime.enabled=true
regime.index.smoothing=0.1
regime.security.ema.fast=8
regime.security.ema.slow=21

# FMA PROCESSOR (Final Magnitude Assembly)
# TEMPORARILY DISABLED: Waiting for upstream topics (vtd-output, vcp-combined, etc.)
fma.enabled=false
fma.cache.ttl.ms=300000

# TRADING SIGNAL PROCESSOR
# TEMPORARILY DISABLED: Depends on FMA processor output
signal.enabled=false
signal.cache.ttl.ms=120000

# ============================================================================
# CURATED SIGNALS (High-Quality Filtered Signals)
# ============================================================================
# TEMPORARILY DISABLED: Depends on signal processor output
curated.enabled=false

# F&O API Configuration - DISABLED (using FamilyCandle data instead)
# The FuturesOptionsService API doesn't exist - we use FamilyCandle data directly
curated.fo.enabled=false
curated.min.magnitude=0.6
curated.min.confirmation.count=3
curated.output.topic=curated-trading-signals

# ============================================================================
# MTIS PROCESSOR (Multi-Timeframe Intelligence Score)
# ============================================================================
mtis.processor.enabled=true
mtis.processor.output.topic=family-score
mtis.producer.batch.size=16384
mtis.producer.linger.ms=5
mtis.producer.buffer.memory=33554432

# ============================================================================
# MASTER ARCHITECTURE (kotsin_FF1 Strategy)
# ============================================================================
masterarch.processor.enabled=true
masterarch.processor.index.scripcode=999920000
masterarch.processor.history.candles=100
masterarch.producer.batch.size=16384
masterarch.producer.linger.ms=5
masterarch.producer.buffer.memory=33554432
masterarch.consumer.group-id=masterarch-consumer-v11
masterarch.consumer.auto-offset-reset=earliest

# ============================================================================
# FUDKII PROCESSOR (Standalone FUDKII Strategy)
# ============================================================================
fudkii.processor.enabled=true
fudkii.processor.min.strength=0.55
fudkii.processor.history.candles=50

# ============================================================================
# OUTPUT TOPICS
# ============================================================================
trading.signals.output.topic=trading-signals
curated.signals.output.topic=curated-trading-signals

# ============================================================================
# SCRIPFINDER API CONFIGURATION
# ============================================================================
scripfinder.api.base-url=${SCRIPFINDER_API_URL:http://13.203.60.173:8102}
scripfinder.api.timeout.ms=${SCRIPFINDER_TIMEOUT_MS:3000}
scripfinder.api.circuit-breaker.failure-threshold=5
scripfinder.api.circuit-breaker.timeout-ms=60000

# ============================================================================
# INSTRUMENT CONFIGURATION (Externalized from hardcoded values)
# ============================================================================
instrument.volume.equity=1000000
instrument.volume.derivatives=5000000
instrument.volume.index=10000000
instrument.tick-size.cash=0.05
instrument.tick-size.derivatives=0.05
instrument.trade-classification.min-absolute=0.01
instrument.trade-classification.basis-points=0.0001
instrument.trade-classification.spread-multiplier=0.15

# ============================================================================
# CALCULATOR CONFIGURATION (All thresholds and algorithm parameters)
# ============================================================================
# VPIN Configuration
calculator.vpin.buckets-per-day=50
calculator.vpin.max-buckets=50
calculator.vpin.min-bucket-size=100.0
calculator.vpin.ewma-alpha=0.05

# OI Signal Detection
calculator.oi-signal.price-threshold=0.1
calculator.oi-signal.oi-threshold=2.0
calculator.oi-signal.option-oi-min-change=1000

# Futures Buildup Detection
calculator.futures-buildup.price-change-threshold=0.1
calculator.futures-buildup.oi-change-threshold=1.0

# Orderbook Microstructure
calculator.orderbook.lambda-window-size=100
calculator.orderbook.lambda-calc-frequency=20
calculator.orderbook.lambda-min-observations=10
calculator.orderbook.iceberg-history-size=20
calculator.orderbook.iceberg-cv-threshold=0.1
calculator.orderbook.iceberg-min-size=1000
calculator.orderbook.spoof-duration-threshold-ms=5000
calculator.orderbook.spoof-size-threshold=0.3

# Imbalance Bars
calculator.imbalance-bar.ewma-alpha=0.1
calculator.imbalance-bar.init-volume-imbalance=1000.0
calculator.imbalance-bar.init-dollar-imbalance=100000.0
calculator.imbalance-bar.init-tick-runs=10.0
calculator.imbalance-bar.init-volume-runs=5000.0
calculator.imbalance-bar.z-score-threshold=1.645

# ============================================================================
# CURATED SIGNAL - MULTI-TIMEFRAME LEVELS (5paisa Historical API)
# ============================================================================
# Uses same 5paisa historical data API as TradeExecutionModule
# API: /getHisDataFromFivePaisa?exch=n&exch_type=c&scrip_code=XXX&start_date=YYYY-MM-DD&end_date=YYYY-MM-DD&interval=1m
curated.levels.enabled=true
curated.levels.api.base-url=http://13.203.60.173:8002
curated.levels.api.timeout-ms=5000
# Exchange: n=NSE, m=MCX (lowercase as per API)
curated.levels.api.exch=n
# Exchange Type: c=Cash, d=Derivatives (lowercase as per API)
curated.levels.api.exch-type=c

# ============================================================================
# GATE CHAIN CONFIGURATION
# ============================================================================
# Enable/disable gate chain
gate.chain.enabled=true

# Hard Gate (Layer 1)
gate.hard.enabled=true
gate.hard.max.oi.age.minutes=15

# MTF Confluence Gate (Layer 2)
gate.mtf.enabled=true
gate.mtf.min.confirmations=3
gate.mtf.vcp.runway.threshold=0.5

# Signal Quality Gate (Layer 3)
gate.quality.enabled=true
gate.quality.min.inst.proxy=0.4
gate.quality.max.exhaustion=0.7
gate.quality.require.volume.confirmation=true

# Stats Gate (Layer 4 - Online Learning)
gate.stats.enabled=true
gate.stats.min.trades=5
gate.stats.min.win.rate=0.35
gate.stats.min.expectancy=-0.2
gate.stats.max.daily.losses=3
gate.stats.use.recent.window=true

# ============================================================================
# REDIS CONFIGURATION (for RedisCandleHistoryService)
# ============================================================================
spring.data.redis.host=${REDIS_HOST:localhost}
spring.data.redis.port=${REDIS_PORT:6379}
spring.data.redis.password=${REDIS_PASSWORD:}
spring.data.redis.database=${REDIS_DB:0}
spring.data.redis.timeout=2000ms
spring.data.redis.lettuce.pool.max-active=8
spring.data.redis.lettuce.pool.max-idle=8
spring.data.redis.lettuce.pool.min-idle=0
redis.candle.history.ttl.hours=48

# ============================================================================
# MONGODB CONFIGURATION (for SignalStats, SignalHistory)
# ============================================================================
spring.data.mongodb.uri=${MONGODB_URI:mongodb://localhost:27017/tradeIngestion}
spring.data.mongodb.auto-index-creation=true

# ============================================================================
# LOGGING
# ============================================================================
logging.level.root=INFO
logging.level.com.kotsin.consumer=INFO
logging.level.com.kotsin.consumer.infrastructure.kafka=DEBUG
logging.level.com.kotsin.consumer.domain.service=DEBUG
logging.level.com.kotsin.consumer.processor=INFO
logging.level.com.kotsin.consumer.regime=INFO
logging.level.com.kotsin.consumer.signal=INFO
logging.level.com.kotsin.consumer.capital=INFO
logging.level.com.kotsin.consumer.curated=DEBUG
logging.level.com.kotsin.consumer.score=INFO
logging.level.org.apache.kafka=WARN

# Pattern with timestamp
logging.pattern.console=%d{HH:mm:ss.SSS} %-5level [%thread] %logger{36} - %msg%n
