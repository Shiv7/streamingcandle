# ğŸ—ï¸ STREAMINGCANDLE ARCHITECTURE DIAGRAM

## Current System Architecture (VERIFIED CORRECT)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        KAFKA INPUT TOPICS                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ forwardtesting-  â”‚  â”‚    Orderbook     â”‚  â”‚  OpenInterest    â”‚      â”‚
â”‚  â”‚      data        â”‚  â”‚                  â”‚  â”‚                  â”‚      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”‚
â”‚  â”‚ Trade Ticks      â”‚  â”‚ 20-level depth   â”‚  â”‚ OI updates       â”‚      â”‚
â”‚  â”‚ 10-100/sec       â”‚  â”‚ 5-50/sec         â”‚  â”‚ every 5-10 sec   â”‚      â”‚
â”‚  â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚      â”‚
â”‚  â”‚ LastRate         â”‚  â”‚ Bids[20]         â”‚  â”‚ OpenInterest     â”‚      â”‚
â”‚  â”‚ LastQty          â”‚  â”‚ Asks[20]         â”‚  â”‚ Token            â”‚      â”‚
â”‚  â”‚ BidRate/OffRate  â”‚  â”‚ TBidQ/TOffQ      â”‚  â”‚                  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚           â”‚                     â”‚                     â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                     â”‚                     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   TopologyConfiguration   â”‚
                    â”‚   (Kafka Streams)         â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ â€¢ Merge 3 streams         â”‚
                    â”‚ â€¢ Rekey by token          â”‚
                    â”‚ â€¢ Market-aligned windows  â”‚
                    â”‚ â€¢ 9:15 AM IST base        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  InstrumentStateManager   â”‚
                    â”‚  (Per-Instrument State)   â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ For EACH scripCode:       â”‚
                    â”‚ â€¢ Track window state      â”‚
                    â”‚ â€¢ Accumulate metrics      â”‚
                    â”‚ â€¢ Emit on window close    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                        â”‚                        â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ Candle  â”‚            â”‚  Imbalance  â”‚         â”‚Microstructureâ”‚
    â”‚Accumulator           â”‚Bar Accumulator        â”‚ Accumulator  â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚â€¢ OHLC   â”‚            â”‚â€¢ VIB        â”‚         â”‚â€¢ OFI        â”‚
    â”‚â€¢ Volume â”‚            â”‚â€¢ DIB        â”‚         â”‚â€¢ VPIN       â”‚
    â”‚â€¢ VWAP   â”‚            â”‚â€¢ TRB        â”‚         â”‚â€¢ Kyle Î»     â”‚
    â”‚â€¢ Buy/Sellâ”‚           â”‚â€¢ VRB        â”‚         â”‚â€¢ Spread     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚â€¢ Progress   â”‚         â”‚â€¢ Microprice â”‚
                           â”‚â€¢ Accelerationâ”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚â€¢ Exhaustion â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Orderbookâ”‚            â”‚â€¢ Divergence â”‚         â”‚    OI       â”‚
    â”‚ Depth   â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ Accumulator â”‚
    â”‚Accumulator                                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤            âš ï¸ MISSING:              â”‚â€¢ OI OHLC    â”‚
    â”‚â€¢ Depth  â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚â€¢ OI Change  â”‚
    â”‚â€¢ Slopes â”‚            â”‚   Volume    â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚â€¢ Icebergsâ”‚           â”‚   Profile   â”‚
    â”‚â€¢ Spoofingâ”‚           â”‚ Accumulator â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                           â”‚â€¢ POC        â”‚
                           â”‚â€¢ Value Area â”‚
                           â”‚â€¢ High Vol   â”‚
                           â”‚  Nodes      â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Window Close Handler    â”‚
                    â”‚   (Suppress Until Close)  â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ â€¢ Wait for grace period   â”‚
                    â”‚ â€¢ Force complete windows  â”‚
                    â”‚ â€¢ Build output message    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      KAFKA OUTPUT TOPICS (per timeframe)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ candle-      â”‚ â”‚ candle-      â”‚ â”‚ candle-      â”‚ â”‚ candle-      â”‚    â”‚
â”‚  â”‚ complete-1m  â”‚ â”‚ complete-2m  â”‚ â”‚ complete-5m  â”‚ â”‚ complete-15m â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚         â”‚ candle-      â”‚ â”‚ candle-      â”‚                                â”‚
â”‚         â”‚ complete-3m  â”‚ â”‚ complete-30m â”‚                                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                                                                            â”‚
â”‚  Output Message Structure: UnifiedWindowMessage                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ {                                                                 â”‚     â”‚
â”‚  â”‚   "scripCode": "96955",                                           â”‚     â”‚
â”‚  â”‚   "timeframe": "1m",                                              â”‚     â”‚
â”‚  â”‚   "candle": {                                                     â”‚     â”‚
â”‚  â”‚     "open": 10.5, "high": 10.6, "low": 10.4, "close": 10.55,    â”‚     â”‚
â”‚  â”‚     "volume": 25200, "buyVolume": 14500, "sellVolume": 10700     â”‚     â”‚
â”‚  â”‚   },                                                              â”‚     â”‚
â”‚  â”‚   "orderbookSignals": {                                           â”‚     â”‚
â”‚  â”‚     "ofi": 15.2, "vpin": 0.35, "depthImbalance": 0.04,          â”‚     â”‚
â”‚  â”‚     "icebergBid": false, "spoofingCount": 0                      â”‚     â”‚
â”‚  â”‚   },                                                              â”‚     â”‚
â”‚  â”‚   "imbalanceBars": {                                              â”‚     â”‚
â”‚  â”‚     "volumeImbalance": { "progress": 0.76, "direction": "BUY" }, â”‚     â”‚
â”‚  â”‚     "dollarImbalance": {...}, "tickRuns": {...}                  â”‚     â”‚
â”‚  â”‚   },                                                              â”‚     â”‚
â”‚  â”‚   "openInterest": { "oiClose": 59200, "oiChange": 200 }          â”‚     â”‚
â”‚  â”‚ }                                                                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                            â”‚
â”‚  âœ… PROVIDES: Raw aggregated metrics only                                 â”‚
â”‚  âŒ EXCLUDES: Trading signals, profit targets, stop losses                â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ Consumed by...
                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SEPARATE TRADING MODULE (Future)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Trading Logic (NOT PART OF STREAMINGCANDLE)                  â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚  â€¢ Read enriched candles                                       â”‚       â”‚
â”‚  â”‚  â€¢ Apply trading strategies                                    â”‚       â”‚
â”‚  â”‚  â€¢ Generate signals: BUY/SELL/WAIT                             â”‚       â”‚
â”‚  â”‚  â€¢ Calculate profit targets & stop losses                      â”‚       â”‚
â”‚  â”‚  â€¢ Execute trades via broker API                               â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Design Principles (VERIFIED)

### âœ… Separation of Concerns
```
StreamingCandle = DATA PROVIDER
â””â”€â”€ Aggregates market data into actionable metrics

Trading Module = DECISION MAKER
â””â”€â”€ Interprets metrics and executes trades
```

### âœ… Single Responsibility Principle
```
Each accumulator does ONE thing:
â”œâ”€â”€ CandleAccumulator â†’ OHLCV only
â”œâ”€â”€ ImbalanceBarAccumulator â†’ Imbalance bars only
â”œâ”€â”€ MicrostructureAccumulator â†’ Microstructure only
â”œâ”€â”€ OrderbookDepthAccumulator â†’ Depth analysis only
â””â”€â”€ OiAccumulator â†’ Open Interest only
```

### âœ… Stateless Output
```
Each output message is:
â”œâ”€â”€ Self-contained (no references to past windows)
â”œâ”€â”€ Immutable (represents completed window)
â”œâ”€â”€ Time-aligned (market-based, not clock-based)
â””â”€â”€ Independent (can be processed out-of-order)
```

---

## Window Alignment (CRITICAL FEATURE)

### Market-Aligned Windows (9:15 AM IST Base)
```
Market Opens: 9:15:00 AM IST

1-minute windows:
â”œâ”€â”€ 9:15:00 â†’ 9:16:00
â”œâ”€â”€ 9:16:00 â†’ 9:17:00
â”œâ”€â”€ 9:17:00 â†’ 9:18:00
â””â”€â”€ ... (375 windows per 6.5-hour session)

5-minute windows:
â”œâ”€â”€ 9:15:00 â†’ 9:20:00
â”œâ”€â”€ 9:20:00 â†’ 9:25:00
â”œâ”€â”€ 9:25:00 â†’ 9:30:00
â””â”€â”€ ... (75 windows per session)

30-minute windows:
â”œâ”€â”€ 9:15:00 â†’ 9:45:00  âœ… Correct!
â”œâ”€â”€ 9:45:00 â†’ 10:15:00
â”œâ”€â”€ 10:15:00 â†’ 10:45:00
â””â”€â”€ ... (13 windows per session)
```

### Grace Period Handling
```
Window Close: 9:18:00
Grace Period: 30 seconds
Final Emit: 9:18:30

Allows late-arriving data while maintaining low latency
```

---

## Timeframe Processing (6 Separate Topologies)

```
For EACH timeframe (1m, 2m, 3m, 5m, 15m, 30m):
â”œâ”€â”€ Create separate Kafka Streams topology
â”œâ”€â”€ Independent state stores
â”œâ”€â”€ Independent window processing
â”œâ”€â”€ Separate output topic
â””â”€â”€ Can scale independently

Benefits:
â”œâ”€â”€ Fault isolation
â”œâ”€â”€ Independent scaling
â”œâ”€â”€ Parallel processing
â””â”€â”€ Easy to add new timeframes
```

---

## Data Flow (Step-by-Step)

```
1. Trade Tick Arrives
   â””â”€â†’ CumToDeltaTransformer (convert cumulative â†’ delta volume)
   â””â”€â†’ Filter invalid ticks
   â””â”€â†’ Rekey by scripCode

2. Orderbook Update Arrives
   â””â”€â†’ Extract token
   â””â”€â†’ Validate (20 levels present)
   â””â”€â†’ Rekey by scripCode

3. OpenInterest Update Arrives
   â””â”€â†’ Extract token
   â””â”€â†’ Store in OI table (KTable)
   â””â”€â†’ Will be joined later

4. Merge Streams
   â””â”€â†’ Combine trade + orderbook events
   â””â”€â†’ Group by scripCode
   â””â”€â†’ Window by timeframe

5. Accumulate State (During Window)
   â””â”€â†’ InstrumentStateManager
        â”œâ”€â†’ CandleAccumulator (OHLC, volume)
        â”œâ”€â†’ ImbalanceBarAccumulator (VIB, DIB, TRB, VRB)
        â”œâ”€â†’ MicrostructureAccumulator (OFI, VPIN, Î»)
        â”œâ”€â†’ OrderbookDepthAccumulator (depth, icebergs)
        â””â”€â†’ OiAccumulator (OI OHLC)

6. Window Closes
   â””â”€â†’ Suppress until window closes completely
   â””â”€â†’ Grace period waits for late data
   â””â”€â†’ Force complete all accumulators
   â””â”€â†’ Build UnifiedWindowMessage

7. Join with OI Table
   â””â”€â†’ Left join to add latest OI
   â””â”€â†’ Calculate OI delta (vs previous window)

8. Emit to Output Topic
   â””â”€â†’ candle-complete-{timeframe}
   â””â”€â†’ Metrics tracked
   â””â”€â†’ Ready for consumption
```

---

## State Management

### Per-Window State (RESETS on window rotation)
```
â”œâ”€â”€ CandleAccumulator
â”œâ”€â”€ ImbalanceBarAccumulator
â”œâ”€â”€ MicrostructureAccumulator
â”œâ”€â”€ OrderbookDepthAccumulator (window metrics only)
â””â”€â”€ OiAccumulator
```

### Cross-Window State (NEVER RESETS)
```
â””â”€â”€ Global OrderbookDepthAccumulator
    â”œâ”€â”€ Iceberg detection (needs history)
    â””â”€â”€ Spoofing detection (needs history)
```

### Strategy: Hybrid Approach
```
Final Output = Window Metrics + Global Detection

orderbookDepth: {
  spread: <from window accumulator>,
  depthImbalance: <from window accumulator>,
  icebergDetectedBid: <from global accumulator>,
  spoofingEvents: <from global accumulator>
}
```

---

## Scaling Characteristics

### Horizontal Scaling
```
Kafka Streams automatically distributes:
â”œâ”€â”€ By scripCode (natural partitioning)
â”œâ”€â”€ Across num.stream.threads=3
â”œâ”€â”€ Can add more application instances
â””â”€â”€ State stores replicated via changelog topics
```

### Performance Metrics
```
Current Configuration:
â”œâ”€â”€ 5000 stocks (realistic NSE/MCX)
â”œâ”€â”€ 100 ticks/sec/stock (peak)
â”œâ”€â”€ 6 timeframes
â”œâ”€â”€ Latency target: <50ms
â”œâ”€â”€ Output size: ~2-3 KB/candle
â””â”€â”€ Daily output: ~5 GB (manageable)
```

---

**Architecture Status:** âœ… PRODUCTION READY
**Missing Component:** âš ï¸ VolumeProfileAccumulator (optional)
**Next Action:** Decide if VolumeProfile is needed