 HIGH-LEVEL DESIGN DOCUMENT
Stateful Multi-Timeframe Trading Intelligence System (SMTIS)
Version 2.0

DOCUMENT CONTROL
VersionDateAuthorChanges1.02026-01-10Architecture TeamInitial Draft2.02026-01-10Architecture TeamAdded Greeks, Alpha Ideas, Brutal Quant Corrections
Reviewers: Quant Team, Engineering Lead, Risk Management
Status: DRAFT - Pending Review

TABLE OF CONTENTS

Executive Summary
Current State Analysis
Problem Statement
Target State Architecture
Module Breakdown
Data Models
Data Flow Architecture
Storage Architecture
Interface Contracts
Configuration Management
Deployment Architecture
Migration Strategy
Testing Strategy
Risk Assessment
Implementation Phases
Appendices


SECTION 1: EXECUTIVE SUMMARY
1.1 Purpose
This document defines the architecture for transforming the existing stateless candle processing system into a stateful, context-aware, alpha-generating trading intelligence platform.
1.2 Scope
In Scope:

Historical context enrichment for all existing metrics
Greeks calculation from raw option data
Multi-timeframe technical indicators
Support/Resistance confluence detection
Event detection and lifecycle management
Signal generation across trading horizons
Time and expiry awareness
MongoDB persistence for backtesting/ML

Out of Scope:

Cross-asset correlation (separate initiative)
Order execution/management
Portfolio management
Risk management systems (separate module)
UI/Dashboard development

1.3 Key Objectives
ObjectiveSuccess MetricEliminate hardcoded thresholds0 hardcoded threshold values in signal logicUse all captured data100% of calculated fields have signal integrationAdd historical memoryRolling windows for all key metricsMulti-timeframe awarenessLTF signals incorporate HTF contextTime-aware signalsConfidence adjusted by session/expiryCalculate GreeksIV, Delta, Gamma, Theta, Vega, GEX from raw dataImprove signal quality>60% directional accuracy (vs current ~50%)Enable backtestingAll enriched data persisted to MongoDB
1.4 High-Level Architecture Overview
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           SMTIS - HIGH LEVEL ARCHITECTURE                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         EXISTING LAYER (Unchanged)                       │   │
│  │                                                                         │   │
│  │   Ticks ──► InstrumentCandle ──► FamilyCandle ──► family-candle-{tf}   │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         NEW ENRICHMENT LAYER                            │   │
│  │                                                                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌────────────┐  │   │
│  │  │  Historical  │  │  Technical   │  │   Greeks     │  │   Event    │  │   │
│  │  │   Context    │  │  Indicators  │  │ Calculator   │  │  Detector  │  │   │
│  │  │  Enricher    │  │  Enricher    │  │              │  │            │  │   │
│  │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └─────┬──────┘  │   │
│  │         └─────────────────┴─────────────────┴────────────────┘         │   │
│  │                                        │                                │   │
│  │                                        ▼                                │   │
│  │                          ┌──────────────────────┐                       │   │
│  │                          │   MTF Confluence     │                       │   │
│  │                          │     Calculator       │                       │   │
│  │                          └──────────┬───────────┘                       │   │
│  │                                     │                                   │   │
│  │                                     ▼                                   │   │
│  │                          ┌──────────────────────┐                       │   │
│  │                          │  Signal Generator    │                       │   │
│  │                          │ (Scalp/Swing/Pos)    │                       │   │
│  │                          └──────────┬───────────┘                       │   │
│  │                                     │                                   │   │
│  └─────────────────────────────────────┼───────────────────────────────────┘   │
│                                        │                                        │
│                    ┌───────────────────┼───────────────────┐                   │
│                    ▼                   ▼                   ▼                   │
│            ┌─────────────┐    ┌─────────────┐    ┌─────────────┐              │
│            │  enriched-  │    │  detected-  │    │  trading-   │              │
│            │   family-   │    │   events    │    │  signals    │              │
│            │ candle-{tf} │    │             │    │             │              │
│            └──────┬──────┘    └──────┬──────┘    └──────┬──────┘              │
│                   │                  │                  │                      │
│                   └──────────────────┴──────────────────┘                      │
│                                      │                                         │
│                                      ▼                                         │
│                          ┌──────────────────────┐                              │
│                          │   MongoDB Sink       │                              │
│                          │   (Persistence)      │                              │
│                          └──────────────────────┘                              │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                         STATE STORES                                    │   │
│  │                                                                         │   │
│  │   ┌─────────────┐      ┌─────────────┐      ┌─────────────┐            │   │
│  │   │    REDIS    │      │   ROCKSDB   │      │   MONGODB   │            │   │
│  │   │  (Hot State)│      │(Stream State)│      │(Cold State) │            │   │
│  │   │             │      │             │      │             │            │   │
│  │   │ • History   │      │ • EMA accum │      │ • Candles   │            │   │
│  │   │ • Regimes   │      │ • ATR state │      │ • Events    │            │   │
│  │   │ • Events    │      │ • BB state  │      │ • Signals   │            │   │
│  │   │ • Greeks    │      │             │      │ • Indicators│            │   │
│  │   │ • Session   │      │             │      │ • ML Data   │            │   │
│  │   └─────────────┘      └─────────────┘      └─────────────┘            │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

SECTION 2: CURRENT STATE ANALYSIS
2.1 Existing Data Pipeline
┌─────────────────────────────────────────────────────────────────────────────┐
│                        CURRENT DATA FLOW                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  KAFKA TOPICS (Input)                                                       │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                                  │
│  │  ticks   │  │ orderbook│  │    oi    │                                  │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘                                  │
│       │             │             │                                         │
│       └─────────────┼─────────────┘                                         │
│                     ▼                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  UnifiedInstrumentCandleProcessor                                   │   │
│  │  ────────────────────────────────                                   │   │
│  │  • 1-minute tumbling window                                         │   │
│  │  • Aggregates OHLCV                                                 │   │
│  │  • Calculates: OFI, VPIN, Kyle's Lambda, Depth metrics             │   │
│  │  • Calculates: Volume Profile (POC, VAH, VAL)                      │   │
│  │  • Merges orderbook and OI data                                     │   │
│  │                                                                     │   │
│  │  OUTPUT: InstrumentCandle (per scripCode)                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                     │                                                       │
│                     ▼                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  FamilyCandleProcessor                                              │   │
│  │  ─────────────────────                                              │   │
│  │  • Groups by familyId (equity + future + 4 options)                │   │
│  │  • Calculates: PCR, Spot-Future Premium                            │   │
│  │  • Calculates: OI Signals (hardcoded thresholds!)                  │   │
│  │  • Calculates: Futures Buildup                                     │   │
│  │                                                                     │   │
│  │  OUTPUT: FamilyCandle                                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                     │                                                       │
│                     ▼                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  TimeframeAggregator                                                │   │
│  │  ─────────────────────                                              │   │
│  │  • Aggregates 1m → 3m, 5m, 15m, 30m, 1h, 1d                        │   │
│  │  • Simple OHLCV merge                                               │   │
│  │  • Grace period for late arrivals                                   │   │
│  │                                                                     │   │
│  │  OUTPUT: FamilyCandle (per timeframe)                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                     │                                                       │
│                     ▼                                                       │
│  KAFKA TOPICS (Output)                                                      │
│  ┌────────────────────────────────────────────────────────────────────┐    │
│  │  family-candle-1m  │  family-candle-3m  │  family-candle-5m        │    │
│  │  family-candle-15m │  family-candle-30m │  family-candle-1d        │    │
│  └────────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
2.2 Existing Data Fields Captured
2.2.1 InstrumentCandle Fields (118 fields)
CategoryField CountExamplesIdentity8scripCode, symbol, exchange, instrumentTypeTiming5windowStartMillis, windowEndMillis, timeframeOHLCV Core10open, high, low, close, volume, buyVolumeTrade Classification6aggressiveBuyVolume, buyPressure, classificationReliabilityVolume Profile4volumeAtPrice, poc, vah, valImbalance8volumeImbalance, dollarImbalance, tickRunsOrderbook Microstructure28ofi, kyleLambda, microprice, depthImbalanceVPIN3vpin, vpinBucketSize, vpinBucketCountOpen Interest12oiOpen, oiHigh, oiChange, oiVelocityOptions Specific6strikePrice, optionType, daysToExpiryData Quality8quality, tickStale, orderbookStaleGap Analysis4previousClose, overnightGap, isGapUpSpread Analysis8bidAskSpread, spreadVolatility, maxSpreadTick Timing8firstTickTimestamp, minTickGap, ticksPerSecondTrade Size6maxTradeSize, avgTradeSize, largeTradeCount
2.2.2 FamilyCandle Additional Fields (45 fields)
CategoryField CountExamplesIdentity6familyId, symbol, timeframeInstruments4equity, future, options[], primaryInstrumentSpot-Future4spotFuturePremium, premiumExpanding, futuresBuildupOptions Analysis8pcr, maxPain, atmIV, ivSkewOI Dynamics10callOiBuildingUp, putOiUnwinding, totalCallOIReversal Detection8ofiVelocity, exhaustionDetected, reversalScoreCross-Instrument5volumeConfluence, signalStrength
2.3 Data Captured But Not Used
FieldLocationCurrent UsageShould Be Used ForkyleLambdaInstrumentCandleStored onlyLiquidity regime, absorption detectionvpinInstrumentCandleStored onlyInformed flow detection, signal filteringbidDepthSlopeInstrumentCandleStored onlyBook shape analysis, institutional detectionaskDepthSlopeInstrumentCandleStored onlyBook shape analysisspreadVolatilityInstrumentCandleStored onlyLiquidity withdrawal detectionoiVelocityInstrumentCandleStored onlyOI acceleration, momentumtickRunsInstrumentCandleStored onlyMomentum qualitylargeTradeCountInstrumentCandleStored onlyInstitutional participationavgBidOrderSizeInstrumentCandleStored onlyInstitutional biasavgAskOrderSizeInstrumentCandleStored onlyInstitutional bias
2.4 Hardcoded Thresholds (Technical Debt)
FileConstantValueProblemOISignalDetector.javaOPTION_OI_MIN_CHANGE1000Too high for commoditiesOISignalDetector.javaOI_THRESHOLD2.0%Too high for intradayFamilyCandleProcessor.javafutureOiBuildingUp> 2%Hardcoded, ignores configReversalSignalCalculator.javaOFI_EXHAUSTION_THRESHOLD-500Absolute, not relativeMicrostructureGate.javaVariousMultipleNot instrument-adaptive

SECTION 3: PROBLEM STATEMENT
3.1 Core Problems
P1: Stateless Processing (Amnesia)
CURRENT: Candle → Process → Emit → FORGET

Each candle processed independently.
No memory of previous values.
Cannot detect:
  - Regime changes (OFI was negative for 10 candles, just flipped)
  - Trends (OI building for 30 minutes)
  - Patterns (exhaustion after sustained selling)
P2: Hardcoded Thresholds
CURRENT: if (oiChange > 1000) → signal

Problems:
  - NATURALGAS OI base = 4000, so +200 (5%) is significant
  - NIFTY OI base = 10,000,000, so +1000 (0.01%) is noise
  - Same threshold cannot work for both
P3: Unused Data (Waste)
CURRENT: Calculate Kyle's Lambda → Store → Never use

We compute sophisticated metrics:
  - Kyle's Lambda (price impact)
  - VPIN (informed trading)
  - Book shape (depth slopes)
  - Spread volatility

But never integrate them into signals.
This is like having a car with no wheels.
P4: No Greeks
CURRENT: Have option price, OI, strike → No Greeks

We have everything needed to calculate:
  - Implied Volatility
  - Delta, Gamma, Theta, Vega
  - GEX (Gamma Exposure)

But we don't calculate them.
Missing: trending vs mean-reverting regime detection.
P5: No Time/Expiry Awareness
CURRENT: Same signal at 9:30 AM treated same as 2:30 PM

Reality:
  - 9:30-10:00: Opening noise, 60% false signals
  - 10:00-12:00: Prime trading, signals reliable
  - 12:00-13:30: Lunch chop, 80% false signals
  - Expiry day: OI signals meaningless, gamma dominates
P6: No Multi-Timeframe Context
CURRENT: 1m processor doesn't know what daily says

Reality:
  - 1m bullish + Daily bearish = Counter-trend scalp only
  - 1m bullish + Daily bullish = Full position swing

Without HTF context, LTF signals have no edge.
3.2 Business Impact
ProblemImpactP1: AmnesiaMiss 70% of reversal signals (need sequence detection)P2: HardcodedCommodity signals don't trigger (threshold too high)P3: Unused Data40% of compute wasted, missing alphaP4: No GreeksCannot predict trending vs ranging daysP5: No Time Awareness50%+ of signals during bad sessionsP6: No MTFWrong position sizing, fighting trend
3.3 Requirements
Functional Requirements
IDRequirementPriorityFR-01System shall maintain rolling history of key metricsP0FR-02System shall use percentile/z-score based thresholdsP0FR-03System shall detect regime changes (OFI, Volume, OI)P0FR-04System shall calculate IV from option pricesP0FR-05System shall calculate Greeks (Delta, Gamma, Theta, Vega)P0FR-06System shall calculate GEX (Gamma Exposure)P0FR-07System shall calculate Max PainP1FR-08System shall detect gamma squeeze setupsP1FR-09System shall adjust signals by time of dayP0FR-10System shall adjust signals by expiry proximityP0FR-11System shall calculate multi-timeframe technical indicatorsP1FR-12System shall detect support/resistance confluenceP1FR-13System shall track event lifecycle (detect → confirm/fail)P1FR-14System shall calculate MTF alignmentP1FR-15System shall generate signals by horizon (scalp/swing/pos)P1FR-16System shall persist all enriched data to MongoDBP0
Non-Functional Requirements
IDRequirementTargetNFR-01Enrichment latency< 50ms per candleNFR-02State lookup latency< 5ms (Redis)NFR-03System availability99.9% during market hoursNFR-04Data freshness< 100ms from candle emit to enriched emitNFR-05State recovery< 30 seconds on processor restartNFR-06Storage efficiency< 1KB per enriched candle (compressed)

SECTION 4: TARGET STATE ARCHITECTURE
4.1 Architecture Principles
PrincipleDescriptionStateful ProcessingEvery enricher maintains state, nothing is forgottenRelative ThresholdsAll thresholds based on percentile/z-score, never absoluteCompute Once, Use ManyCalculate metrics once, reference from multiple enrichersFail SafeMissing state = reduced confidence, not failureBackward CompatibleExisting consumers can ignore new fieldsObservableAll enrichment steps logged for debuggingTestableEach enricher independently unit testable
4.2 Logical Architecture
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         LOGICAL ARCHITECTURE                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                        PRESENTATION LAYER                                  │ │
│  │                                                                           │ │
│  │   Kafka Topics (Output):                                                  │ │
│  │   • enriched-family-candle-{tf}  - Full enriched candles                 │ │
│  │   • detected-events              - Detected market events                 │ │
│  │   • trading-signals              - Actionable signals                     │ │
│  │   • regime-changes               - Regime transition alerts               │ │
│  │                                                                           │ │
│  └───────────────────────────────────────────────────────────────────────────┘ │
│                                        ▲                                        │
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                        ORCHESTRATION LAYER                                │ │
│  │                                                                           │ │
│  │   ┌─────────────────────────────────────────────────────────────────┐    │ │
│  │   │              EnrichmentOrchestrator                             │    │ │
│  │   │                                                                 │    │ │
│  │   │  • Coordinates all enrichers                                    │    │ │
│  │   │  • Manages enrichment sequence                                  │    │ │
│  │   │  • Handles failures gracefully                                  │    │ │
│  │   │  • Emits to appropriate topics                                  │    │ │
│  │   └─────────────────────────────────────────────────────────────────┘    │ │
│  │                                                                           │ │
│  └───────────────────────────────────────────────────────────────────────────┘ │
│                                        ▲                                        │
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                        ENRICHMENT LAYER                                   │ │
│  │                                                                           │ │
│  │   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │ │
│  │   │ Historical  │ │ Technical   │ │  Greeks     │ │   Time      │       │ │
│  │   │  Context    │ │ Indicators  │ │ Calculator  │ │  Context    │       │ │
│  │   │  Enricher   │ │  Enricher   │ │             │ │  Enricher   │       │ │
│  │   └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘       │ │
│  │                                                                           │ │
│  │   ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │ │
│  │   │ Confluence  │ │   Event     │ │    MTF      │ │   Signal    │       │ │
│  │   │ Calculator  │ │  Detector   │ │ Calculator  │ │ Generator   │       │ │
│  │   └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘       │ │
│  │                                                                           │ │
│  └───────────────────────────────────────────────────────────────────────────┘ │
│                                        ▲                                        │
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                          STATE LAYER                                      │ │
│  │                                                                           │ │
│  │   ┌───────────────────┐  ┌───────────────────┐  ┌───────────────────┐   │ │
│  │   │   StateManager    │  │  IndicatorStore   │  │   EventStore      │   │ │
│  │   │                   │  │                   │  │                   │   │ │
│  │   │ • Load state      │  │ • Daily pivots    │  │ • Pending events  │   │ │
│  │   │ • Save state      │  │ • Weekly pivots   │  │ • Event log       │   │ │
│  │   │ • TTL management  │  │ • BB values       │  │ • Confirmations   │   │ │
│  │   │ • Failover        │  │ • ATR values      │  │                   │   │ │
│  │   └───────────────────┘  └───────────────────┘  └───────────────────┘   │ │
│  │                                                                           │ │
│  └───────────────────────────────────────────────────────────────────────────┘ │
│                                        ▲                                        │
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                        DATA ACCESS LAYER                                  │ │
│  │                                                                           │ │
│  │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │ │
│  │   │  RedisClient    │  │  RocksDBStore   │  │  MongoClient    │         │ │
│  │   │                 │  │                 │  │                 │         │ │
│  │   │ • Hot state     │  │ • Stream state  │  │ • Cold state    │         │ │
│  │   │ • Pub/Sub       │  │ • Changelog     │  │ • Historical    │         │ │
│  │   │ • TTL support   │  │ • Recovery      │  │ • ML data       │         │ │
│  │   └─────────────────┘  └─────────────────┘  └─────────────────┘         │ │
│  │                                                                           │ │
│  └───────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
4.3 Component Architecture
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         COMPONENT ARCHITECTURE                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                    ENRICHMENT ORCHESTRATOR                              │   │
│  │                                                                         │   │
│  │  Input: FamilyCandle (from family-candle-{tf})                         │   │
│  │                                                                         │   │
│  │  ┌─────────────────────────────────────────────────────────────────┐   │   │
│  │  │                    ENRICHMENT PIPELINE                          │   │   │
│  │  │                                                                 │   │   │
│  │  │   STEP 1: Context Loading                                       │   │   │
│  │  │   ┌─────────────────────────────────────────────────────────┐  │   │   │
│  │  │   │  TimeContextEnricher                                    │  │   │   │
│  │  │   │  • Extract session (MORNING_TREND, LUNCH_CHOP, etc.)   │  │   │   │
│  │  │   │  • Extract expiry context (DTE, expiry phase)          │  │   │   │
│  │  │   │  • Calculate confidence modifiers                       │  │   │   │
│  │  │   └─────────────────────────────────────────────────────────┘  │   │   │
│  │  │                            │                                    │   │   │
│  │  │                            ▼                                    │   │   │
│  │  │   STEP 2: Historical Enrichment                                │   │   │
│  │  │   ┌─────────────────────────────────────────────────────────┐  │   │   │
│  │  │   │  HistoricalContextEnricher                              │  │   │   │
│  │  │   │  • Load rolling histories from Redis                    │  │   │   │
│  │  │   │  • Calculate statistics (mean, stddev, percentile)     │  │   │   │
│  │  │   │  • Detect regimes (OFI, Volume, OI, Lambda, VPIN)      │  │   │   │
│  │  │   │  • Detect flips and transitions                         │  │   │   │
│  │  │   │  • Update histories                                     │  │   │   │
│  │  │   └─────────────────────────────────────────────────────────┘  │   │   │
│  │  │                            │                                    │   │   │
│  │  │                            ▼                                    │   │   │
│  │  │   STEP 3: Greeks Calculation                                   │   │   │
│  │  │   ┌─────────────────────────────────────────────────────────┐  │   │   │
│  │  │   │  GreeksCalculator                                       │  │   │   │
│  │  │   │  • Calculate IV for each option (Newton-Raphson)       │  │   │   │
│  │  │   │  • Calculate all Greeks (Δ, Γ, Θ, V, ρ)               │  │   │   │
│  │  │   │  • Aggregate family-level Greeks                       │  │   │   │
│  │  │   │  • Calculate GEX (Gamma Exposure)                      │  │   │   │
│  │  │   │  • Calculate Max Pain                                   │  │   │   │
│  │  │   │  • Detect gamma squeeze setups                         │  │   │   │
│  │  │   │  • Track IV skew                                        │  │   │   │
│  │  │   └─────────────────────────────────────────────────────────┘  │   │   │
│  │  │                            │                                    │   │   │
│  │  │                            ▼                                    │   │   │
│  │  │   STEP 4: Technical Indicators                                 │   │   │
│  │  │   ┌─────────────────────────────────────────────────────────┐  │   │   │
│  │  │   │  TechnicalIndicatorEnricher                             │  │   │   │
│  │  │   │  • Load daily/weekly/monthly pivots from MongoDB       │  │   │   │
│  │  │   │  • Load pre-calculated BB, ATR from MongoDB            │  │   │   │
│  │  │   │  • Calculate current-TF indicators (if needed)         │  │   │   │
│  │  │   │  • Calculate session VWAP from Redis                   │  │   │   │
│  │  │   │  • Calculate SuperTrend state                          │  │   │   │
│  │  │   └─────────────────────────────────────────────────────────┘  │   │   │
│  │  │                            │                                    │   │   │
│  │  │                            ▼                                    │   │   │
│  │  │   STEP 5: Confluence Calculation                               │   │   │
│  │  │   ┌─────────────────────────────────────────────────────────┐  │   │   │
│  │  │   │  ConfluenceCalculator                                   │  │   │   │
│  │  │   │  • Collect all S/R levels                              │  │   │   │
│  │  │   │  • Group nearby levels into zones                      │  │   │   │
│  │  │   │  • Calculate zone strength                             │  │   │   │
│  │  │   │  • Find nearest support/resistance                     │  │   │   │
│  │  │   │  • Detect price in confluence zone                     │  │   │   │
│  │  │   └─────────────────────────────────────────────────────────┘  │   │   │
│  │  │                            │                                    │   │   │
│  │  │                            ▼                                    │   │   │
│  │  │   STEP 6: Event Detection                                      │   │   │
│  │  │   ┌─────────────────────────────────────────────────────────┐  │   │   │
│  │  │   │  EventDetector                                          │  │   │   │
│  │  │   │  • Detect microstructure events (OFI flip, exhaustion) │  │   │   │
│  │  │   │  • Detect technical events (ST flip, BB touch)         │  │   │   │
│  │  │   │  • Detect OI events (surge, unwinding)                 │  │   │   │
│  │  │   │  • Detect price events (breakout, retest)              │  │   │   │
│  │  │   │  • Check pending event confirmations                    │  │   │   │
│  │  │   │  • Update event lifecycle                               │  │   │   │
│  │  │   └─────────────────────────────────────────────────────────┘  │   │   │
│  │  │                            │                                    │   │   │
│  │  │                            ▼                                    │   │   │
│  │  │   STEP 7: MTF Alignment                                        │   │   │
│  │  │   ┌─────────────────────────────────────────────────────────┐  │   │   │
│  │  │   │  MTFConfluenceCalculator                                │  │   │   │
│  │  │   │  • Load other timeframe states from Redis              │  │   │   │
│  │  │   │  • Calculate LTF/MTF/HTF consensus                     │  │   │   │
│  │  │   │  • Detect conflicts                                     │  │   │   │
│  │  │   │  • Calculate alignment score                           │  │   │   │
│  │  │   │  • Determine recommended horizon                        │  │   │   │
│  │  │   └─────────────────────────────────────────────────────────┘  │   │   │
│  │  │                            │                                    │   │   │
│  │  │                            ▼                                    │   │   │
│  │  │   STEP 8: Signal Generation                                    │   │   │
│  │  │   ┌─────────────────────────────────────────────────────────┐  │   │   │
│  │  │   │  SignalGenerator                                        │  │   │   │
│  │  │   │  • Evaluate signal conditions                          │  │   │   │
│  │  │   │  • Apply all confidence modifiers                      │  │   │   │
│  │  │   │  • Apply Greeks filters (GEX regime, max pain)         │  │   │   │
│  │  │   │  • Calculate entry/stop/target                         │  │   │   │
│  │  │   │  • Generate per-horizon signals                        │  │   │   │
│  │  │   └─────────────────────────────────────────────────────────┘  │   │   │
│  │  │                                                                 │   │   │
│  │  └─────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                         │   │
│  │  Output:                                                                │   │
│  │  • EnrichedFamilyCandle → enriched-family-candle-{tf}                  │   │
│  │  • DetectedEvent[] → detected-events                                   │   │
│  │  • TradingSignal[] → trading-signals                                   │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
4.4 Sequence Diagram
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         ENRICHMENT SEQUENCE                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  FamilyCandle    Orchestrator    Redis    Enrichers    MongoDB    Kafka        │
│       │               │            │          │           │          │          │
│       │   consume     │            │          │           │          │          │
│       │──────────────>│            │          │           │          │          │
│       │               │            │          │           │          │          │
│       │               │ load state │          │           │          │          │
│       │               │───────────>│          │           │          │          │
│       │               │<───────────│          │           │          │          │
│       │               │  history[] │          │           │          │          │
│       │               │            │          │           │          │          │
│       │               │ load indicators       │           │          │          │
│       │               │───────────────────────────────────>│          │          │
│       │               │<───────────────────────────────────│          │          │
│       │               │  daily pivots, BB, ATR             │          │          │
│       │               │            │          │           │          │          │
│       │               │ enrich     │          │           │          │          │
│       │               │───────────────────────>│           │          │          │
│       │               │            │          │           │          │          │
│       │               │            │  TimeContextEnricher  │          │          │
│       │               │            │  HistoricalEnricher   │          │          │
│       │               │            │  GreeksCalculator     │          │          │
│       │               │            │  TechnicalEnricher    │          │          │
│       │               │            │  ConfluenceCalc       │          │          │
│       │               │            │  EventDetector        │          │          │
│       │               │            │  MTFCalculator        │          │          │
│       │               │            │  SignalGenerator      │          │          │
│       │               │            │          │           │          │          │
│       │               │<───────────────────────│           │          │          │
│       │               │ EnrichedCandle         │           │          │          │
│       │               │ Events[]               │           │          │          │
│       │               │ Signals[]              │           │          │          │
│       │               │            │          │           │          │          │
│       │               │ update state          │           │          │          │
│       │               │───────────>│          │           │          │          │
│       │               │            │          │           │          │          │
│       │               │ emit                  │           │          │          │
│       │               │──────────────────────────────────────────────>│          │
│       │               │            │          │           │          │          │
│       │               │ persist async         │           │          │          │
│       │               │───────────────────────────────────>│          │          │
│       │               │            │          │           │          │          │
│                                                                                 │
│  Total Latency Target: < 50ms                                                   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

SECTION 5: MODULE BREAKDOWN
5.1 Module Overview
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           MODULE HIERARCHY                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  com.kotsin.consumer                                                            │
│  │                                                                              │
│  ├── enrichment/                    ← NEW PACKAGE                               │
│  │   │                                                                          │
│  │   ├── orchestrator/                                                          │
│  │   │   ├── EnrichmentOrchestrator.java         [M-01]                        │
│  │   │   ├── EnrichmentPipeline.java             [M-02]                        │
│  │   │   └── EnrichmentContext.java              [M-03]                        │
│  │   │                                                                          │
│  │   ├── enricher/                                                              │
│  │   │   ├── TimeContextEnricher.java            [M-04]                        │
│  │   │   ├── HistoricalContextEnricher.java      [M-05]                        │
│  │   │   ├── GreeksCalculator.java               [M-06]                        │
│  │   │   ├── TechnicalIndicatorEnricher.java     [M-07]                        │
│  │   │   ├── ConfluenceCalculator.java           [M-08]                        │
│  │   │   ├── EventDetector.java                  [M-09]                        │
│  │   │   ├── MTFConfluenceCalculator.java        [M-10]                        │
│  │   │   └── SignalGenerator.java                [M-11]                        │
│  │   │                                                                          │
│  │   ├── state/                                                                 │
│  │   │   ├── StateManager.java                   [M-12]                        │
│  │   │   ├── HistoryBuffer.java                  [M-13]                        │
│  │   │   ├── RegimeDetector.java                 [M-14]                        │
│  │   │   └── EventStore.java                     [M-15]                        │
│  │   │                                                                          │
│  │   ├── calculator/                                                            │
│  │   │   ├── BlackScholesCalculator.java         [M-16]                        │
│  │   │   ├── IVCalculator.java                   [M-17]                        │
│  │   │   ├── GEXCalculator.java                  [M-18]                        │
│  │   │   ├── MaxPainCalculator.java              [M-19]                        │
│  │   │   ├── StatisticsCalculator.java           [M-20]                        │
│  │   │   └── ThresholdCalculator.java            [M-21]                        │
│  │   │                                                                          │
│  │   ├── model/                                                                 │
│  │   │   ├── EnrichedFamilyCandle.java           [M-22]                        │
│  │   │   ├── HistoricalContext.java              [M-23]                        │
│  │   │   ├── TimeContext.java                    [M-24]                        │
│  │   │   ├── GreeksPortfolio.java                [M-25] (exists, enhance)      │
│  │   │   ├── TechnicalContext.java               [M-26]                        │
│  │   │   ├── ConfluenceZone.java                 [M-27]                        │
│  │   │   ├── DetectedEvent.java                  [M-28]                        │
│  │   │   ├── MTFState.java                       [M-29]                        │
│  │   │   ├── TradingSignal.java                  [M-30]                        │
│  │   │   └── RegimeState.java                    [M-31]                        │
│  │   │                                                                          │
│  │   └── config/                                                                │
│  │       ├── EnrichmentConfig.java               [M-32]                        │
│  │       ├── ThresholdConfig.java                [M-33]                        │
│  │       ├── SessionConfig.java                  [M-34]                        │
│  │       └── GreeksConfig.java                   [M-35]                        │
│  │                                                                              │
│  ├── persistence/                   ← NEW PACKAGE                               │
│  │   ├── MongoSinkService.java                   [M-36]                        │
│  │   ├── IndicatorPersistenceService.java        [M-37]                        │
│  │   └── repository/                                                            │
│  │       ├── EnrichedCandleRepository.java       [M-38]                        │
│  │       ├── EventRepository.java                [M-39]                        │
│  │       ├── SignalRepository.java               [M-40]                        │
│  │       └── IndicatorRepository.java            [M-41]                        │
│  │                                                                              │
│  ├── job/                           ← NEW PACKAGE                               │
│  │   ├── DailyIndicatorJob.java                  [M-42]                        │
│  │   ├── WeeklyIndicatorJob.java                 [M-43]                        │
│  │   └── MonthlyIndicatorJob.java                [M-44]                        │
│  │                                                                              │
│  └── infrastructure/                                                            │
│      └── redis/                     ← NEW PACKAGE                               │
│          ├── RedisStateClient.java               [M-45]                        │
│          └── RedisHistoryClient.java             [M-46]                        │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
5.2 Module Specifications
M-01: EnrichmentOrchestrator
┌─────────────────────────────────────────────────────────────────────────────────┐
│  MODULE: EnrichmentOrchestrator                                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  PURPOSE:                                                                       │
│  Main entry point for enrichment pipeline. Consumes FamilyCandle from Kafka,   │
│  orchestrates all enrichers, and emits enriched data.                          │
│                                                                                 │
│  RESPONSIBILITIES:                                                              │
│  • Consume from family-candle-{tf} topics                                      │
│  • Create EnrichmentContext                                                    │
│  • Execute enrichment pipeline                                                 │
│  • Handle errors gracefully (emit with reduced enrichment)                     │
│  • Emit to output topics                                                       │
│  • Track metrics and latency                                                   │
│                                                                                 │
│  DEPENDENCIES:                                                                  │
│  • EnrichmentPipeline                                                          │
│  • StateManager                                                                │
│  • KafkaTemplate (for output)                                                  │
│  • MeterRegistry (for metrics)                                                 │
│                                                                                 │
│  INPUT:                                                                         │
│  • FamilyCandle (from Kafka)                                                   │
│                                                                                 │
│  OUTPUT:                                                                        │
│  • EnrichedFamilyCandle → enriched-family-candle-{tf}                         │
│  • DetectedEvent[] → detected-events                                          │
│  • TradingSignal[] → trading-signals                                          │
│                                                                                 │
│  CONFIGURATION:                                                                 │
│  • enrichment.enabled: true/false                                              │
│  • enrichment.timeout-ms: 100                                                  │
│  • enrichment.emit-partial-on-failure: true                                    │
│                                                                                 │
│  ERROR HANDLING:                                                                │
│  • Individual enricher failure → Continue with others, mark in context        │
│  • State load failure → Use defaults, reduced confidence                      │
│  • Total timeout → Emit partial enrichment                                    │
│                                                                                 │
│  METRICS:                                                                       │
│  • enrichment.latency.total                                                    │
│  • enrichment.latency.per_enricher                                            │
│  • enrichment.errors.count                                                    │
│  • enrichment.candles.processed                                               │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
M-05: HistoricalContextEnricher
┌─────────────────────────────────────────────────────────────────────────────────┐
│  MODULE: HistoricalContextEnricher                                              │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  PURPOSE:                                                                       │
│  Adds historical context to candle by loading rolling histories, calculating   │
│  statistics, detecting regimes, and identifying regime transitions.            │
│                                                                                 │
│  RESPONSIBILITIES:                                                              │
│  • Load rolling histories from Redis                                           │
│  • Add current values to histories                                             │
│  • Calculate statistics (mean, stddev, percentile, z-score)                   │
│  • Detect regimes for each metric                                              │
│  • Detect regime flips/transitions                                             │
│  • Calculate confidence modifiers                                              │
│  • Save updated histories to Redis                                             │
│                                                                                 │
│  METRICS ENRICHED:                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │  Metric          │ History │ Stats │ Regime │ Flip Detection         │     │
│  │──────────────────│─────────│───────│────────│────────────────────────│     │
│  │  OFI             │   ✓     │   ✓   │   ✓    │   ✓                    │     │
│  │  Volume Delta    │   ✓     │   ✓   │   ✓    │   ✓                    │     │
│  │  OI Change       │   ✓     │   ✓   │   ✓    │   ✓                    │     │
│  │  OI Velocity     │   ✓     │   ✓   │   ✓    │   ✓                    │     │
│  │  Kyle's Lambda   │   ✓     │   ✓   │   ✓    │   ✓ (absorption)       │     │
│  │  VPIN            │   ✓     │   ✓   │   ✓    │   ✓ (toxic flow)       │     │
│  │  Spread          │   ✓     │   ✓   │   ✓    │   ✓ (liquidity)        │     │
│  │  Depth Imbalance │   ✓     │   ✓   │   ✓    │   ✓                    │     │
│  │  Book Shape      │   ✓     │   ✓   │   ✓    │   -                    │     │
│  │  Buy Pressure    │   ✓     │   ✓   │   ✓    │   ✓                    │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  REGIME DETECTION ALGORITHM:                                                    │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │  1. Calculate percentile of current value in history                 │     │
│  │  2. Calculate consecutive count in same direction                    │     │
│  │  3. Calculate z-score                                                │     │
│  │                                                                       │     │
│  │  REGIME CLASSIFICATION:                                               │     │
│  │    percentile > 80 AND consecutive >= 3 → STRONG_POSITIVE           │     │
│  │    percentile > 60 OR consecutive >= 2  → POSITIVE                  │     │
│  │    percentile < 20 AND consecutive >= 3 → STRONG_NEGATIVE           │     │
│  │    percentile < 40 OR consecutive >= 2  → NEGATIVE                  │     │
│  │    otherwise                            → NEUTRAL                    │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  FLIP DETECTION:                                                                │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │  IF previous_regime IN [NEGATIVE, STRONG_NEGATIVE]                   │     │
│  │     AND current_regime IN [POSITIVE, STRONG_POSITIVE]:               │     │
│  │                                                                       │     │
│  │     flip_detected = TRUE                                             │     │
│  │     flip_type = BEARISH_TO_BULLISH                                   │     │
│  │     flip_magnitude = abs(current - previous)                         │     │
│  │     flip_zscore = flip_magnitude / stddev                            │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  SPECIAL DETECTION (Using Previously Unused Data):                              │
│                                                                                 │
│  ABSORPTION DETECTION (Kyle's Lambda + Depth):                                  │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │  IF lambda_zscore < -1.0 (unusually low price impact)                │     │
│  │     AND depth_imbalance < -0.3 (ask heavy)                          │     │
│  │     AND price_change >= 0 (not falling)                              │     │
│  │     AND ofi > 0 (buyers aggressive):                                 │     │
│  │                                                                       │     │
│  │     absorption_detected = TRUE                                        │     │
│  │     absorption_type = BULLISH_ACCUMULATION                           │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  LIQUIDITY WITHDRAWAL DETECTION:                                                │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │  IF lambda_zscore > 2.0 (high price impact)                          │     │
│  │     AND spread_zscore > 1.5 (widening spread)                        │     │
│  │     AND depth declining:                                              │     │
│  │                                                                       │     │
│  │     liquidity_withdrawal = TRUE                                       │     │
│  │     → BIG MOVE IMMINENT                                               │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  INFORMED FLOW DETECTION (VPIN):                                                │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │  IF vpin > 0.7:                                                       │     │
│  │     vpin_regime = HIGH_TOXIC                                          │     │
│  │     → Informed traders active, don't fade                            │     │
│  │                                                                       │     │
│  │  IF vpin_was_high AND vpin_now < 0.5 AND vpin_falling:               │     │
│  │     → Informed traders done, reversal possible                        │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  DEPENDENCIES:                                                                  │
│  • StateManager (for Redis access)                                             │
│  • StatisticsCalculator                                                        │
│  • RegimeDetector                                                              │
│                                                                                 │
│  OUTPUT:                                                                        │
│  • HistoricalContext object added to EnrichmentContext                         │
│                                                                                 │
│  CONFIGURATION:                                                                 │
│  • history.buffer.size: 20                                                     │
│  • history.metrics: [ofi, volumeDelta, oiChange, ...]                         │
│  • regime.strong.percentile: 80                                                │
│  • regime.weak.percentile: 40                                                  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
M-06: GreeksCalculator
┌─────────────────────────────────────────────────────────────────────────────────┐
│  MODULE: GreeksCalculator                                                        │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  PURPOSE:                                                                       │
│  Calculate complete Greeks portfolio from raw option data including IV,        │
│  Delta, Gamma, Theta, Vega, GEX, Max Pain, and detect gamma squeeze setups.   │
│                                                                                 │
│  CALCULATION FLOW:                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │                                                                       │     │
│  │  For each option in FamilyCandle:                                    │     │
│  │                                                                       │     │
│  │  1. CALCULATE IV                                                      │     │
│  │     ├── Extract: option_price, spot, strike, time_to_expiry         │     │
│  │     ├── Apply Newton-Raphson iteration                               │     │
│  │     └── Fallback to Brenner-Subrahmanyam approximation if needed    │     │
│  │                                                                       │     │
│  │  2. CALCULATE GREEKS                                                  │     │
│  │     ├── d1 = [ln(S/K) + (r - q + σ²/2)T] / (σ√T)                    │     │
│  │     ├── d2 = d1 - σ√T                                                │     │
│  │     ├── Delta = e^(-qT) × N(d1) for calls                           │     │
│  │     ├── Gamma = e^(-qT) × n(d1) / (S × σ × √T)                      │     │
│  │     ├── Theta = -(S × e^(-qT) × n(d1) × σ) / (2√T) - ...           │     │
│  │     ├── Vega = S × e^(-qT) × n(d1) × √T                             │     │
│  │     └── Rho = K × T × e^(-rT) × N(d2)                               │     │
│  │                                                                       │     │
│  │  3. AGGREGATE FAMILY GREEKS                                           │     │
│  │     ├── total_delta = Σ(delta × OI × multiplier)                    │     │
│  │     ├── total_gamma = Σ(gamma × OI × multiplier)                    │     │
│  │     └── ... for all Greeks                                           │     │
│  │                                                                       │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  GEX CALCULATION:                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │                                                                       │     │
│  │  ASSUMPTION: Dealers are NET SHORT options (sold to retail)          │     │
│  │                                                                       │     │
│  │  For each strike:                                                     │     │
│  │    call_gex = call_gamma × call_oi × spot × 100                     │     │
│  │    put_gex = put_gamma × put_oi × spot × 100                        │     │
│  │    net_gex = call_gex - put_gex                                      │     │
│  │                                                                       │     │
│  │  total_gex = Σ(net_gex) across all strikes                          │     │
│  │                                                                       │     │
│  │  INTERPRETATION:                                                      │     │
│  │    total_gex < 0 → Dealers SHORT gamma → TRENDING market            │     │
│  │                    Dealers chase price → Moves amplify               │     │
│  │                    Breakouts will RUN                                 │     │
│  │                                                                       │     │
│  │    total_gex > 0 → Dealers LONG gamma → MEAN REVERTING market       │     │
│  │                    Dealers fade moves → Moves dampen                 │     │
│  │                    Breakouts will FAIL                               │     │
│  │                                                                       │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  MAX PAIN CALCULATION:                                                          │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │                                                                       │     │
│  │  For each potential settlement price K:                               │     │
│  │                                                                       │     │
│  │    call_pain = Σ [call_oi × max(0, K - strike)] for all strikes    │     │
│  │    put_pain = Σ [put_oi × max(0, strike - K)] for all strikes      │     │
│  │    total_pain(K) = call_pain + put_pain                             │     │
│  │                                                                       │     │
│  │  max_pain_strike = K where total_pain(K) is MINIMUM                 │     │
│  │                                                                       │     │
│  │  On expiry day afternoon, price gravitates to max_pain_strike       │     │
│  │                                                                       │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  GAMMA SQUEEZE DETECTION:                                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │                                                                       │     │
│  │  CALL SQUEEZE (Bullish):                                             │     │
│  │    IF strike within 3% ABOVE spot                                    │     │
│  │       AND high call OI at strike                                     │     │
│  │       AND negative GEX at strike                                     │     │
│  │       AND price momentum positive:                                   │     │
│  │                                                                       │     │
│  │       → GAMMA SQUEEZE ALERT                                          │     │
│  │       → Target = strike + measured_move                              │     │
│  │                                                                       │     │
│  │  PUT SQUEEZE (Bearish):                                              │     │
│  │    IF strike within 3% BELOW spot                                    │     │
│  │       AND high put OI at strike                                      │     │
│  │       AND negative GEX at strike                                     │     │
│  │       AND price momentum negative:                                   │     │
│  │                                                                       │     │
│  │       → GAMMA SQUEEZE ALERT (bearish)                                │     │
│  │                                                                       │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  IV SKEW TRACKING:                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │                                                                       │     │
│  │  iv_skew = atm_put_iv - atm_call_iv                                 │     │
│  │                                                                       │     │
│  │  Track iv_skew_history[20]                                           │     │
│  │  Calculate iv_skew_zscore, iv_skew_trend                            │     │
│  │                                                                       │     │
│  │  iv_skew rising → Fear increasing → BEARISH bias                    │     │
│  │  iv_skew falling → Fear decreasing → BULLISH bias                   │     │
│  │  iv_skew_zscore > 2 → Extreme fear → Contrarian LONG                │     │
│  │                                                                       │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  DEPENDENCIES:                                                                  │
│  • BlackScholesCalculator                                                      │
│  • IVCalculator                                                                │
│  • GEXCalculator                                                               │
│  • MaxPainCalculator                                                           │
│  • StateManager (for IV skew history)                                          │
│                                                                                 │
│  OUTPUT:                                                                        │
│  • GreeksPortfolio object added to EnrichmentContext                           │
│                                                                                 │
│  CONFIGURATION:                                                                 │
│  • greeks.risk-free-rate: 0.065                                                │
│  • greeks.dividend-yield: 0.01                                                 │
│  • greeks.iv.max-iterations: 100                                               │
│  • greeks.iv.tolerance: 0.0001                                                 │
│  • greeks.gex.trending-threshold: -1000000                                     │
│  • greeks.squeeze.distance-threshold: 0.03                                     │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
M-04: TimeContextEnricher
┌─────────────────────────────────────────────────────────────────────────────────┐
│  MODULE: TimeContextEnricher                                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  PURPOSE:                                                                       │
│  Add time-of-day and expiry context to adjust signal confidence.               │
│                                                                                 │
│  SESSION CLASSIFICATION (NSE):                                                  │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │  Session          │ Time        │ Quality │ Confidence │ Character   │     │
│  │───────────────────│─────────────│─────────│────────────│─────────────│     │
│  │  PRE_MARKET       │ 09:00-09:15 │  0.0    │   0.0      │ No trading  │     │
│  │  OPENING_AUCTION  │ 09:15-09:20 │  0.2    │   0.3      │ Gap settle  │     │
│  │  OPENING_RANGE    │ 09:20-10:00 │  0.4    │   0.6      │ Range form  │     │
│  │  MORNING_TREND    │ 10:00-12:00 │  1.0    │   1.0      │ PRIME       │     │
│  │  LUNCH_CHOP       │ 12:00-13:30 │  0.2    │   0.4      │ Avoid       │     │
│  │  AFTERNOON        │ 13:30-14:30 │  0.8    │   0.9      │ Reposition  │     │
│  │  POWER_HOUR       │ 14:30-15:30 │  0.6    │   0.8      │ High vol    │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  SESSION CLASSIFICATION (MCX):                                                  │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │  Session          │ Time        │ Quality │ Character                 │     │
│  │───────────────────│─────────────│─────────│───────────────────────────│     │
│  │  MORNING          │ 09:00-17:00 │  0.7    │ Track equity markets      │     │
│  │  EVENING_OPEN     │ 17:00-18:00 │  0.8    │ International open        │     │
│  │  EVENING_PRIME    │ 18:00-21:00 │  1.0    │ Max intl overlap          │     │
│  │  EVENING_LATE     │ 21:00-23:30 │  0.6    │ US market tracking        │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  EXPIRY CONTEXT:                                                                │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │  Phase         │ DTE    │ OI Weight │ Gamma Weight │ Max Pain       │     │
│  │────────────────│────────│───────────│──────────────│────────────────│     │
│  │  FAR           │ > 14   │   1.0     │     1.0      │   0.3          │     │
│  │  APPROACH      │ 7-14   │   0.8     │     1.2      │   0.5          │     │
│  │  NEAR          │ 3-7    │   0.5     │     1.5      │   0.8          │     │
│  │  EXPIRY_WEEK   │ 1-3    │   0.2     │     2.0      │   1.2          │     │
│  │  EXPIRY_DAY    │ 0      │   0.0     │     2.5      │   1.5          │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  OUTPUT:                                                                        │
│  • TimeContext object with all modifiers                                       │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
M-09: EventDetector
┌─────────────────────────────────────────────────────────────────────────────────┐
│  MODULE: EventDetector                                                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  PURPOSE:                                                                       │
│  Detect significant market events and manage their lifecycle.                  │
│                                                                                 │
│  EVENT TYPES:                                                                   │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │  Category       │ Event Type            │ Detection Criteria         │     │
│  │─────────────────│───────────────────────│────────────────────────────│     │
│  │  MICROSTRUCTURE │ OFI_FLIP              │ OFI regime changed         │     │
│  │                 │ VOLUME_DELTA_FLIP     │ Volume regime changed      │     │
│  │                 │ SELLING_EXHAUSTION    │ OFI negative, vel positive │     │
│  │                 │ BUYING_EXHAUSTION     │ OFI positive, vel negative │     │
│  │                 │ ABSORPTION            │ Lambda low + depth vs flow │     │
│  │                 │ LIQUIDITY_WITHDRAWAL  │ Lambda high + spread wide  │     │
│  │                 │ SWEEP                 │ Multi-level hit rapid      │     │
│  │─────────────────│───────────────────────│────────────────────────────│     │
│  │  TECHNICAL      │ SUPERTREND_FLIP       │ ST direction changed       │     │
│  │                 │ BB_UPPER_TOUCH        │ Price >= BB upper          │     │
│  │                 │ BB_LOWER_TOUCH        │ Price <= BB lower          │     │
│  │                 │ BB_SQUEEZE_START      │ BB width < percentile 10   │     │
│  │                 │ PIVOT_TEST            │ Price at S/R level         │     │
│  │─────────────────│───────────────────────│────────────────────────────│     │
│  │  OPTIONS        │ CALL_OI_SURGE         │ Call OI > 2 stddev         │     │
│  │                 │ PUT_OI_UNWINDING      │ Put OI declining + price ↑ │     │
│  │                 │ IV_SKEW_EXTREME       │ Skew zscore > 2            │     │
│  │                 │ GAMMA_SQUEEZE_SETUP   │ GEX + proximity + momentum │     │
│  │─────────────────│───────────────────────│────────────────────────────│     │
│  │  PRICE          │ BREAKOUT_ATTEMPT      │ Price testing resistance   │     │
│  │                 │ BREAKDOWN_ATTEMPT     │ Price testing support      │     │
│  │                 │ NEW_SESSION_HIGH      │ Price > session high       │     │
│  │                 │ RETEST                │ Price at breached level    │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  EVENT LIFECYCLE:                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │                                                                       │     │
│  │  DETECTED ─────► PENDING ─────► CONFIRMED                            │     │
│  │                     │              │                                  │     │
│  │                     │              └──► Store outcome, learn          │     │
│  │                     │                                                 │     │
│  │                     └─────► FAILED                                    │     │
│  │                     │         │                                       │     │
│  │                     │         └──► Store failure reason, learn        │     │
│  │                     │                                                 │     │
│  │                     └─────► EXPIRED                                   │     │
│  │                               │                                       │     │
│  │                               └──► No clear outcome                   │     │
│  │                                                                       │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  CONFIRMATION CRITERIA (Examples):                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │  Event              │ Confirmation              │ Failure             │     │
│  │─────────────────────│───────────────────────────│─────────────────────│     │
│  │  OFI_FLIP (bull)    │ Price +0.5% in 30 min    │ Price -0.5% in 30   │     │
│  │  SUPERTREND_FLIP    │ Price stays above ST 3c  │ Price back below    │     │
│  │  BB_LOWER_TOUCH     │ Price bounces to middle  │ Price breaks lower  │     │
│  │  GAMMA_SQUEEZE      │ Price exceeds strike     │ Price reverses      │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  DEPENDENCIES:                                                                  │
│  • EventStore (for pending events)                                             │
│  • HistoricalContext (for regime data)                                         │
│  • GreeksPortfolio (for options events)                                        │
│  • TechnicalContext (for technical events)                                     │
│                                                                                 │
│  OUTPUT:                                                                        │
│  • List<DetectedEvent> - newly detected events                                 │
│  • List<DetectedEvent> - confirmed events                                      │
│  • List<DetectedEvent> - failed events                                         │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
M-11: SignalGenerator
┌─────────────────────────────────────────────────────────────────────────────────┐
│  MODULE: SignalGenerator                                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  PURPOSE:                                                                       │
│  Generate actionable trading signals by horizon with confidence scores.        │
│                                                                                 │
│  SIGNAL HORIZONS:                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │  Horizon     │ Timeframes │ Hold Time  │ Primary Signals             │     │
│  │──────────────│────────────│────────────│─────────────────────────────│     │
│  │  SCALP       │ 1m, 3m, 5m │ 5-30 min   │ OFI flip, exhaustion, sweep │     │
│  │  SWING       │ 15m, 30m   │ 1-4 hours  │ OI signals, ST flip, retest │     │
│  │  POSITIONAL  │ Daily      │ 1-5 days   │ HTF trend, daily OI buildup │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  SIGNAL STRUCTURE:                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │  signal = {                                                           │     │
│  │    signal_id: UUID,                                                   │     │
│  │    family_id: "NATURALGAS",                                          │     │
│  │    timestamp: ...,                                                    │     │
│  │    timeframe: "1m",                                                   │     │
│  │    horizon: "SCALP",                                                  │     │
│  │    direction: "LONG",                                                 │     │
│  │    confidence: 0.82,                                                  │     │
│  │                                                                       │     │
│  │    // Entry                                                           │     │
│  │    entry_price: 296.2,                                               │     │
│  │    entry_reason: ["OFI_FLIP", "BB_LOWER_TOUCH", "ABSORPTION"],       │     │
│  │                                                                       │     │
│  │    // Risk Management                                                 │     │
│  │    stop_loss: 295.0,                                                 │     │
│  │    stop_reason: "Below confluence support",                          │     │
│  │    target_1: 298.0,                                                  │     │
│  │    target_2: 300.0,                                                  │     │
│  │    risk_reward: 1.8,                                                 │     │
│  │                                                                       │     │
│  │    // Context                                                         │     │
│  │    supporting_events: ["evt_123", "evt_124"],                        │     │
│  │    mtf_alignment: "LTF_BULLISH_HTF_BEARISH",                         │     │
│  │    gex_regime: "TRENDING",                                           │     │
│  │    session: "MORNING_TREND",                                         │     │
│  │                                                                       │     │
│  │    // Modifiers applied                                               │     │
│  │    modifiers: {                                                       │     │
│  │      time_modifier: 1.0,                                             │     │
│  │      expiry_modifier: 0.8,                                           │     │
│  │      gex_modifier: 1.2,                                              │     │
│  │      vpin_modifier: 0.9,                                             │     │
│  │      mtf_modifier: 0.8                                               │     │
│  │    },                                                                 │     │
│  │                                                                       │     │
│  │    // Sizing                                                          │     │
│  │    recommended_size: 0.5,  // 50% due to HTF conflict                │     │
│  │                                                                       │     │
│  │    // Validity                                                        │     │
│  │    valid_until: timestamp + 30 minutes                               │     │
│  │  }                                                                    │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  CONFIDENCE CALCULATION:                                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │                                                                       │     │
│  │  base_confidence = 0.5                                               │     │
│  │                                                                       │     │
│  │  // Add for each supporting signal                                   │     │
│  │  FOR each signal IN supporting_signals:                              │     │
│  │      base_confidence += signal.weight  // 0.05 - 0.15 each          │     │
│  │                                                                       │     │
│  │  // Apply modifiers                                                  │     │
│  │  confidence = base_confidence                                        │     │
│  │  confidence *= time_context.confidence_modifier                      │     │
│  │  confidence *= expiry_context.oi_weight                              │     │
│  │  confidence *= gex_regime_modifier                                   │     │
│  │  confidence *= vpin_modifier                                         │     │
│  │  confidence *= mtf_alignment_modifier                                │     │
│  │  confidence *= lambda_modifier                                       │     │
│  │                                                                       │     │
│  │  // Cap at 0.95                                                      │     │
│  │  confidence = min(0.95, confidence)                                  │     │
│  │                                                                       │     │
│  │  // Threshold for emission                                           │     │
│  │  IF confidence < 0.6: DO NOT EMIT                                    │     │
│  │                                                                       │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  GEX REGIME FILTER:                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │                                                                       │     │
│  │  IF gex_regime == "TRENDING":                                        │     │
│  │      BOOST: BREAKOUT, MOMENTUM, TREND_FOLLOW signals (×1.2)         │     │
│  │      REDUCE: MEAN_REVERSION, FADE, RANGE signals (×0.7)             │     │
│  │                                                                       │     │
│  │  IF gex_regime == "MEAN_REVERTING":                                  │     │
│  │      BOOST: MEAN_REVERSION, FADE, BB_TOUCH signals (×1.2)           │     │
│  │      REDUCE: BREAKOUT, MOMENTUM signals (×0.7)                       │     │
│  │                                                                       │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  MAX PAIN FILTER (Expiry Day):                                                  │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │                                                                       │     │
│  │  IF is_expiry_day AND hour > 12:                                     │     │
│  │                                                                       │     │
│  │      distance_to_max_pain = |spot - max_pain| / spot                 │     │
│  │                                                                       │     │
│  │      IF distance > 1.5%:                                             │     │
│  │          Expect mean reversion to max pain                           │     │
│  │          IF signal toward max_pain: confidence *= 1.3               │     │
│  │          IF signal away from max_pain: confidence *= 0.7            │     │
│  │                                                                       │     │
│  │      IF distance < 0.5%:                                             │     │
│  │          Expect PIN at max pain                                      │     │
│  │          All directional signals: confidence *= 0.5                  │     │
│  │                                                                       │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
│                                                                                 │
│  DEPENDENCIES:                                                                  │
│  • All enrichment contexts (Historical, Technical, Greeks, MTF, Events)        │
│  • ThresholdCalculator                                                         │
│  • StateManager                                                                │
│                                                                                 │
│  OUTPUT:                                                                        │
│  • List<TradingSignal> → trading-signals topic                                 │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

SECTION 6: DATA MODELS
6.1 EnrichedFamilyCandle
┌─────────────────────────────────────────────────────────────────────────────────┐
│  MODEL: EnrichedFamilyCandle                                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  EXTENDS: FamilyCandle (all existing fields preserved)                         │
│                                                                                 │
│  NEW SECTIONS:                                                                  │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  timeContext: TimeContext                                               │   │
│  │  ├── sessionName: String           // MORNING_TREND, LUNCH_CHOP, etc.  │   │
│  │  ├── sessionQuality: Double        // 0.0 - 1.0                        │   │
│  │  ├── confidenceModifier: Double    // 0.3 - 1.0                        │   │
│  │  ├── isPrimeSession: Boolean                                           │   │
│  │  ├── expiryPhase: String           // FAR, APPROACH, NEAR, EXPIRY_DAY  │   │
│  │  ├── daysToExpiry: Integer                                             │   │
│  │  ├── oiSignalWeight: Double        // 0.0 - 1.0                        │   │
│  │  ├── gammaSignalWeight: Double     // 1.0 - 2.5                        │   │
│  │  ├── maxPainWeight: Double         // 0.3 - 1.5                        │   │
│  │  ├── isExpiryDay: Boolean                                              │   │
│  │  └── maxPainMagnetActive: Boolean                                      │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  historicalContext: HistoricalContext                                   │   │
│  │  │                                                                      │   │
│  │  ├── ofiContext: MetricContext                                         │   │
│  │  │   ├── history: Double[20]                                           │   │
│  │  │   ├── mean: Double                                                  │   │
│  │  │   ├── stdDev: Double                                                │   │
│  │  │   ├── zScore: Double                                                │   │
│  │  │   ├── percentile: Double                                            │   │
│  │  │   ├── regime: String            // STRONG_BUY, BUY, NEUTRAL, etc.   │   │
│  │  │   ├── regimeDuration: Integer                                       │   │
│  │  │   ├── previousRegime: String                                        │   │
│  │  │   ├── flipDetected: Boolean                                         │   │
│  │  │   ├── flipMagnitude: Double                                         │   │
│  │  │   └── candlesSinceFlip: Integer                                     │   │
│  │  │                                                                      │   │
│  │  ├── volumeDeltaContext: MetricContext                                 │   │
│  │  ├── oiChangeContext: MetricContext                                    │   │
│  │  ├── oiVelocityContext: MetricContext                                  │   │
│  │  ├── lambdaContext: MetricContext                                      │   │
│  │  ├── vpinContext: MetricContext                                        │   │
│  │  ├── spreadContext: MetricContext                                      │   │
│  │  ├── depthImbalanceContext: MetricContext                              │   │
│  │  ├── bookShapeContext: MetricContext                                   │   │
│  │  │                                                                      │   │
│  │  ├── absorptionDetected: Boolean                                       │   │
│  │  ├── absorptionType: String        // BULLISH_ACCUMULATION, etc.       │   │
│  │  ├── absorptionDuration: Integer                                       │   │
│  │  │                                                                      │   │
│  │  ├── liquidityWithdrawal: Boolean                                      │   │
│  │  ├── liquidityWithdrawalStrength: Double                               │   │
│  │  │                                                                      │   │
│  │  ├── informedFlowActive: Boolean                                       │   │
│  │  ├── informedFlowDirection: String                                     │   │
│  │  │                                                                      │   │
│  │  ├── institutionalParticipation: String  // HIGH, MEDIUM, LOW          │   │
│  │  ├── momentumQuality: String       // STRONG, MODERATE, WEAK           │   │
│  │  │                                                                      │   │
│  │  └── overallConfidenceModifier: Double                                 │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  greeksPortfolio: GreeksPortfolio                                       │   │
│  │  │                                                                      │   │
│  │  ├── optionGreeks: List<OptionGreeks>                                  │   │
│  │  │   └── { strike, type, iv, delta, gamma, theta, vega }              │   │
│  │  │                                                                      │   │
│  │  ├── totalDelta: Double                                                │   │
│  │  ├── totalGamma: Double                                                │   │
│  │  ├── totalTheta: Double                                                │   │
│  │  ├── totalVega: Double                                                 │   │
│  │  │                                                                      │   │
│  │  ├── callDelta: Double                                                 │   │
│  │  ├── putDelta: Double                                                  │   │
│  │  ├── netDelta: Double                                                  │   │
│  │  │                                                                      │   │
│  │  ├── totalGex: Double                                                  │   │
│  │  ├── gexRegime: String             // TRENDING, MEAN_REVERTING         │   │
│  │  ├── gexByStrike: Map<Double, Double>                                  │   │
│  │  ├── maxGexStrike: Double                                              │   │
│  │  ├── gammaWallUp: Double                                               │   │
│  │  ├── gammaWallDown: Double                                             │   │
│  │  │                                                                      │   │
│  │  ├── atmCallIv: Double                                                 │   │
│  │  ├── atmPutIv: Double                                                  │   │
│  │  ├── ivSkew: Double                                                    │   │
│  │  ├── ivSkewZscore: Double                                              │   │
│  │  ├── ivSkewTrend: String           // RISING, STABLE, FALLING          │   │
│  │  │                                                                      │   │
│  │  ├── maxPainStrike: Double                                             │   │
│  │  ├── distanceToMaxPain: Double                                         │   │
│  │  ├── maxPainMagnetActive: Boolean                                      │   │
│  │  │                                                                      │   │
│  │  ├── squeezeAlert: Boolean                                             │   │
│  │  ├── squeezeDirection: String                                          │   │
│  │  ├── squeezeTarget: Double                                             │   │
│  │  └── squeezeProbability: Double                                        │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  technicalContext: TechnicalContext                                     │   │
│  │  │                                                                      │   │
│  │  ├── dailyPivots: PivotLevels                                          │   │
│  │  │   └── { pp, r1, r2, r3, s1, s2, s3 }                               │   │
│  │  ├── weeklyPivots: PivotLevels                                         │   │
│  │  ├── monthlyPivots: PivotLevels                                        │   │
│  │  │                                                                      │   │
│  │  ├── dailyBB: BollingerBands                                           │   │
│  │  │   └── { upper, middle, lower, width, percentB }                    │   │
│  │  ├── weeklyBB: BollingerBands                                          │   │
│  │  ├── currentBB: BollingerBands                                         │   │
│  │  ├── bbPosition: String            // ABOVE_UPPER, UPPER_HALF, etc.    │   │
│  │  │                                                                      │   │
│  │  ├── dailyATR: Double                                                  │   │
│  │  │                                                                      │   │
│  │  ├── superTrend: Double                                                │   │
│  │  ├── superTrendDirection: String   // BULLISH, BEARISH                 │   │
│  │  ├── superTrendFlipDetected: Boolean                                   │   │
│  │  ├── candlesSinceSTFlip: Integer                                       │   │
│  │  ├── distanceToST: Double                                              │   │
│  │  │                                                                      │   │
│  │  ├── sessionVwap: Double                                               │   │
│  │  ├── sessionHigh: Double                                               │   │
│  │  ├── sessionLow: Double                                                │   │
│  │  │                                                                      │   │
│  │  ├── dailyFib: FibonacciLevels                                         │   │
│  │  └── weeklyFib: FibonacciLevels                                        │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  confluenceZones: ConfluenceContext                                     │   │
│  │  │                                                                      │   │
│  │  ├── zones: List<ConfluenceZone>                                       │   │
│  │  │   └── { price, strength, type, sources[], distancePercent }        │   │
│  │  │                                                                      │   │
│  │  ├── nearestSupport: ConfluenceZone                                    │   │
│  │  ├── nearestResistance: ConfluenceZone                                 │   │
│  │  ├── inConfluenceZone: Boolean                                         │   │
│  │  └── confluenceZoneType: String    // SUPPORT, RESISTANCE, NONE        │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  eventContext: EventContext                                             │   │
│  │  │                                                                      │   │
│  │  ├── detectedEvents: List<String>  // Event IDs detected this candle   │   │
│  │  ├── pendingEvents: List<String>   // Events awaiting confirmation     │   │
│  │  ├── confirmedEvents: List<String> // Recently confirmed               │   │
│  │  └── failedEvents: List<String>    // Recently failed                  │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  mtfState: MTFState                                                     │   │
│  │  │                                                                      │   │
│  │  ├── ltfConsensus: String          // BULLISH, BEARISH, NEUTRAL        │   │
│  │  ├── ltfScore: Double                                                  │   │
│  │  ├── mtfConsensus: String                                              │   │
│  │  ├── mtfScore: Double                                                  │   │
│  │  ├── htfConsensus: String                                              │   │
│  │  ├── htfScore: Double                                                  │   │
│  │  │                                                                      │   │
│  │  ├── overallAlignment: String      // FULLY_ALIGNED, LTF_VS_HTF, etc.  │   │
│  │  ├── alignmentScore: Double        // 0.0 - 1.0                        │   │
│  │  │                                                                      │   │
│  │  ├── recommendedHorizon: String    // SCALP, SWING, POSITIONAL         │   │
│  │  └── positionSizeMultiplier: Double // 0.5 - 1.2                       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  enrichmentMeta: EnrichmentMeta                                         │   │
│  │  │                                                                      │   │
│  │  ├── enrichmentVersion: String     // "2.0.0"                          │   │
│  │  ├── enrichedAt: Long              // Timestamp                        │   │
│  │  ├── totalLatencyMs: Long                                              │   │
│  │  ├── enrichersApplied: List<String>                                    │   │
│  │  ├── enrichersFailed: List<String>                                     │   │
│  │  └── stateLoadSuccess: Boolean                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
6.2 DetectedEvent
┌─────────────────────────────────────────────────────────────────────────────────┐
│  MODEL: DetectedEvent                                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  eventId: String (UUID)                                                         │
│  familyId: String                                                               │
│  eventType: String                                                              │
│  category: String                 // MICROSTRUCTURE, TECHNICAL, OPTIONS, PRICE  │
│  timeframe: String                                                              │
│  detectedAt: Long                                                               │
│  priceAtDetection: Double                                                       │
│                                                                                 │
│  details: Map<String, Object>     // Event-specific data                        │
│  │  Example for OFI_FLIP:                                                      │
│  │  {                                                                          │
│  │    "previousOfi": -434,                                                     │
│  │    "currentOfi": 597,                                                       │
│  │    "flipMagnitude": 1031,                                                   │
│  │    "zScore": 2.5                                                            │
│  │  }                                                                          │
│                                                                                 │
│  expectedDirection: String        // BULLISH, BEARISH                           │
│  confirmationCriteria: String     // "price > 297 within 30 min"               │
│  confirmationWindowMs: Long                                                     │
│                                                                                 │
│  status: String                   // DETECTED, PENDING, CONFIRMED, FAILED       │
│  confirmedAt: Long                                                              │
│  failedAt: Long                                                                 │
│  failureReason: String                                                          │
│                                                                                 │
│  priceAfter5m: Double                                                           │
│  priceAfter15m: Double                                                          │
│  priceAfter30m: Double                                                          │
│  priceAfter1h: Double                                                           │
│  outcome: String                  // SUCCESS, FAILURE, EXPIRED                  │
│                                                                                 │
│  contextSnapshot: Map<String, Object>  // State at detection for ML            │
│  │  {                                                                          │
│  │    "bbPosition": "LOWER_BAND",                                              │
│  │    "stDirection": "BEARISH",                                                │
│  │    "gexRegime": "TRENDING",                                                 │
│  │    "session": "MORNING_TREND",                                              │
│  │    "mtfAlignment": "LTF_VS_HTF"                                             │
│  │  }                                                                          │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
6.3 TradingSignal
┌─────────────────────────────────────────────────────────────────────────────────┐
│  MODEL: TradingSignal                                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  signalId: String (UUID)                                                        │
│  familyId: String                                                               │
│  symbol: String                                                                 │
│  timestamp: Long                                                                │
│  timeframe: String                                                              │
│                                                                                 │
│  horizon: String                  // SCALP, SWING, POSITIONAL                   │
│  direction: String                // LONG, SHORT                                │
│  signalType: String               // MOMENTUM, REVERSAL, BREAKOUT, etc.         │
│  confidence: Double               // 0.0 - 1.0                                  │
│                                                                                 │
│  entryPrice: Double                                                             │
│  entryReasons: List<String>       // ["OFI_FLIP", "BB_LOWER_TOUCH"]            │
│                                                                                 │
│  stopLoss: Double                                                               │
│  stopReason: String                                                             │
│  target1: Double                                                                │
│  target2: Double                                                                │
│  riskReward: Double                                                             │
│                                                                                 │
│  supportingEvents: List<String>   // Event IDs                                  │
│                                                                                 │
│  modifiers: SignalModifiers                                                     │
│  │  ├── timeModifier: Double                                                   │
│  │  ├── expiryModifier: Double                                                 │
│  │  ├── gexModifier: Double                                                    │
│  │  ├── vpinModifier: Double                                                   │
│  │  ├── lambdaModifier: Double                                                 │
│  │  └── mtfModifier: Double                                                    │
│                                                                                 │
│  context: SignalContext                                                         │
│  │  ├── mtfAlignment: String                                                   │
│  │  ├── gexRegime: String                                                      │
│  │  ├── session: String                                                        │
│  │  ├── expiryPhase: String                                                    │
│  │  ├── nearestSupport: Double                                                 │
│  │  └── nearestResistance: Double                                              │
│                                                                                 │
│  recommendedSize: Double          // 0.3 - 1.2 multiplier                       │
│  validUntil: Long                                                               │
│                                                                                 │
│  // Outcome tracking (filled later)                                             │
│  actualEntryPrice: Double                                                       │
│  actualExitPrice: Double                                                        │
│  actualPnlPercent: Double                                                       │
│  outcome: String                  // PROFIT, LOSS, BREAKEVEN, EXPIRED           │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

SECTION 7: DATA FLOW ARCHITECTURE
7.1 Complete Data Flow
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           COMPLETE DATA FLOW                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        EXISTING FLOW (Unchanged)                        │   │
│  │                                                                         │   │
│  │   ticks ───┐                                                            │   │
│  │            │                                                            │   │
│  │  orderbook ├──► UnifiedInstrumentCandleProcessor ──► instrument-candle  │   │
│  │            │                                               │            │   │
│  │   oi ──────┘                                               │            │   │
│  │                                                            │            │   │
│  │                                                            ▼            │   │
│  │                                              ┌──────────────────────┐   │   │
│  │                                              │ FamilyCandleProcessor│   │   │
│  │                                              └──────────┬───────────┘   │   │
│  │                                                         │               │   │
│  │                                                         ▼               │   │
│  │                                              ┌──────────────────────┐   │   │
│  │                                              │TimeframeAggregator   │   │   │
│  │                                              └──────────┬───────────┘   │   │
│  │                                                         │               │   │
│  │                                                         ▼               │   │
│  │                                              family-candle-{1m,3m,5m,  │   │
│  │                                                         15m,30m,1d}    │   │
│  │                                                         │               │   │
│  └─────────────────────────────────────────────────────────┼───────────────┘   │
│                                                            │                    │
│  ══════════════════════════════════════════════════════════╪════════════════   │
│                                                            │                    │
│  ┌─────────────────────────────────────────────────────────┼───────────────┐   │
│  │                        NEW ENRICHMENT FLOW              │               │   │
│  │                                                         ▼               │   │
│  │                                              ┌──────────────────────┐   │   │
│  │                                              │EnrichmentOrchestrator│   │   │
│  │                                              │                      │   │   │
│  │                                              │  ┌────────────────┐  │   │   │
│  │                                              │  │1.TimeContext   │  │   │   │
│  │                       ┌──────────┐           │  └───────┬────────┘  │   │   │
│  │                       │  REDIS   │◄─────────►│          ▼          │   │   │
│  │                       │          │           │  ┌────────────────┐  │   │   │
│  │                       │ •History │           │  │2.Historical    │  │   │   │
│  │                       │ •Regime  │           │  └───────┬────────┘  │   │   │
│  │                       │ •Session │           │          ▼          │   │   │
│  │                       │ •Greeks  │           │  ┌────────────────┐  │   │   │
│  │                       │ •Events  │           │  │3.Greeks        │  │   │   │
│  │                       └──────────┘           │  └───────┬────────┘  │   │   │
│  │                                              │          ▼          │   │   │
│  │                       ┌──────────┐           │  ┌────────────────┐  │   │   │
│  │                       │ MONGODB  │◄─────────►│  │4.Technical     │  │   │   │
│  │                       │          │           │  └───────┬────────┘  │   │   │
│  │                       │ •Pivots  │           │          ▼          │   │   │
│  │                       │ •BB/ATR  │           │  ┌────────────────┐  │   │   │
│  │                       │ •Fibo    │           │  │5.Confluence    │  │   │   │
│  │                       └──────────┘           │  └───────┬────────┘  │   │   │
│  │                                              │          ▼          │   │   │
│  │                                              │  ┌────────────────┐  │   │   │
│  │                                              │  │6.EventDetector │  │   │   │
│  │                                              │  └───────┬────────┘  │   │   │
│  │                                              │          ▼          │   │   │
│  │                                              │  ┌────────────────┐  │   │   │
│  │                                              │  │7.MTFCalculator │  │   │   │
│  │                                              │  └───────┬────────┘  │   │   │
│  │                                              │          ▼          │   │   │
│  │                                              │  ┌────────────────┐  │   │   │
│  │                                              │  │8.SignalGen     │  │   │   │
│  │                                              │  └───────┬────────┘  │   │   │
│  │                                              │          │          │   │   │
│  │                                              └──────────┼──────────┘   │   │
│  │                                                         │               │   │
│  │                              ┌──────────────────────────┼───────────┐  │   │
│  │                              │                          │           │  │   │
│  │                              ▼                          ▼           ▼  │   │
│  │                   enriched-family-      detected-    trading-          │   │
│  │                      candle-{tf}         events       signals          │   │
│  │                              │              │           │              │   │
│  └──────────────────────────────┼──────────────┼───────────┼──────────────┘   │
│                                 │              │           │                   │
│  ═══════════════════════════════╪══════════════╪═══════════╪═══════════════   │
│                                 │              │           │                   │
│  ┌──────────────────────────────┼──────────────┼───────────┼──────────────┐   │
│  │                        PERSISTENCE FLOW     │           │              │   │
│  │                                 │              │           │              │   │
│  │                                 └──────────────┴───────────┘              │   │
│  │                                               │                           │   │
│  │                                               ▼                           │   │
│  │                                    ┌──────────────────┐                   │   │
│  │                                    │  MongoSinkService │                   │   │
│  │                                    └────────┬─────────┘                   │   │
│  │                                             │                             │   │
│  │                                             ▼                             │   │
│  │                                    ┌──────────────────┐                   │   │
│  │                                    │     MONGODB      │                   │   │
│  │                                    │                  │                   │   │
│  │                                    │ • candles_enriched│                   │   │
│  │                                    │ • events         │                   │   │
│  │                                    │ • signals        │                   │   │
│  │                                    │ • ml_features    │                   │   │
│  │                                    └──────────────────┘                   │   │
│  │                                                                           │   │
│  └───────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
7.2 State Access Patterns
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         STATE ACCESS PATTERNS                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ENRICHER              READS FROM                  WRITES TO                    │
│  ─────────────────────────────────────────────────────────────────────────────  │
│                                                                                 │
│  TimeContextEnricher   • (none - pure function)    • (none)                    │
│                                                                                 │
│  HistoricalEnricher    • Redis: history buffers    • Redis: updated histories  │
│                        • Redis: regime state       • Redis: regime state       │
│                        • Redis: previous candle    • Redis: previous candle    │
│                                                                                 │
│  GreeksCalculator      • Redis: IV history         • Redis: IV history         │
│                        • Redis: skew history       • Redis: skew history       │
│                        • Redis: GEX history        • Redis: Greeks snapshot    │
│                                                                                 │
│  TechnicalEnricher     • MongoDB: daily pivots     • (none - read only)        │
│                        • MongoDB: weekly pivots                                 │
│                        • MongoDB: BB/ATR values                                 │
│                        • Redis: session VWAP                                    │
│                        • Redis: ST state           • Redis: ST state           │
│                                                                                 │
│  ConfluenceCalculator  • (uses TechnicalContext)   • (none)                    │
│                                                                                 │
│  EventDetector         • Redis: pending events     • Redis: pending events     │
│                        • All contexts              • Redis: event log          │
│                                                                                 │
│  MTFCalculator         • Redis: other TF states    • Redis: current TF state   │
│                                                                                 │
│  SignalGenerator       • All contexts              • (none - produces output)  │
│                        • Redis: cooldown cache                                  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

SECTION 8: STORAGE ARCHITECTURE
8.1 Redis Schema
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           REDIS SCHEMA                                           │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  ROLLING HISTORY (List)                                                         │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  Key Pattern: {familyId}:{timeframe}:history:{metric}                          │
│                                                                                 │
│  Examples:                                                                       │
│    NATURALGAS:1m:history:ofi           → [-434, 597, 455, ...]  (20 values)    │
│    NATURALGAS:1m:history:volumeDelta   → [-27, 46, 18, ...]                     │
│    NATURALGAS:1m:history:oiChange      → [19, 25, -10, ...]                     │
│    NATURALGAS:1m:history:lambda        → [-2.3e-7, ...]                         │
│    NATURALGAS:1m:history:vpin          → [0.24, 0.31, ...]                      │
│    NATURALGAS:1m:history:spread        → [0.05, 0.06, ...]                      │
│    NATURALGAS:1m:history:depth         → [-0.22, -0.18, ...]                    │
│                                                                                 │
│  Operations:                                                                     │
│    LPUSH + LTRIM (keep last 20-50)                                             │
│    LRANGE 0 -1 (get all)                                                        │
│                                                                                 │
│  TTL: 24 hours                                                                  │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  REGIME STATE (Hash)                                                            │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  Key Pattern: {familyId}:{timeframe}:regime                                    │
│                                                                                 │
│  Fields:                                                                         │
│    ofiRegime             → "BUY"                                                │
│    ofiRegimeDuration     → 3                                                    │
│    ofiPreviousRegime     → "SELL"                                               │
│    ofiFlipCandle         → 1767981540000                                        │
│    volumeDeltaRegime     → "POSITIVE"                                           │
│    oiRegime              → "BUILDUP"                                            │
│    lambdaRegime          → "NORMAL"                                             │
│    vpinRegime            → "MODERATE"                                           │
│    spreadRegime          → "NORMAL"                                             │
│    absorptionActive      → "true"                                               │
│    absorptionType        → "BULLISH_ACCUMULATION"                               │
│    liquidityWithdrawal   → "false"                                              │
│                                                                                 │
│  TTL: None (continuously updated)                                               │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  PREVIOUS CANDLE (Hash)                                                         │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  Key Pattern: {familyId}:{timeframe}:prev                                      │
│                                                                                 │
│  Fields:                                                                         │
│    ofi                   → -434                                                 │
│    volumeDelta           → -27                                                  │
│    oiChange              → 15                                                   │
│    close                 → 295.7                                                │
│    volume                → 1200                                                 │
│    lambda                → -2.3e-7                                              │
│    vpin                  → 0.24                                                 │
│    timestamp             → 1767981360000                                        │
│                                                                                 │
│  TTL: 2 hours                                                                   │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  GREEKS SNAPSHOT (Hash)                                                         │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  Key Pattern: {familyId}:greeks                                                │
│                                                                                 │
│  Fields:                                                                         │
│    totalDelta            → -2845                                                │
│    totalGamma            → 156.7                                                │
│    totalGex              → -4500000                                             │
│    gexRegime             → "TRENDING"                                           │
│    atmCallIv             → 0.38                                                 │
│    atmPutIv              → 0.42                                                 │
│    ivSkew                → 0.04                                                 │
│    maxPainStrike         → 305                                                  │
│    squeezeAlert          → "true"                                               │
│    squeezeDirection      → "BULLISH"                                            │
│    lastUpdated           → 1767981600000                                        │
│                                                                                 │
│  TTL: None (updated every candle)                                               │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  IV/SKEW HISTORY (List)                                                         │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  Key Pattern: {familyId}:greeks:history:{metric}                               │
│                                                                                 │
│  Examples:                                                                       │
│    NATURALGAS:greeks:history:ivSkew    → [0.04, 0.03, 0.05, ...]              │
│    NATURALGAS:greeks:history:gex       → [-4500000, -4200000, ...]            │
│                                                                                 │
│  TTL: 24 hours                                                                  │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  SESSION STATE (Hash)                                                           │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  Key Pattern: {familyId}:session:{date}                                        │
│                                                                                 │
│  Fields:                                                                         │
│    vwap                  → 297.5                                                │
│    vwapVolume            → 125000                                               │
│    sessionHigh           → 312.9                                                │
│    sessionLow            → 295.7                                                │
│    openingRangeHigh      → 310.5                                                │
│    openingRangeLow       → 307.2                                                │
│    superTrendValue       → 298.4                                                │
│    superTrendDirection   → "BEARISH"                                            │
│    candlesSinceSTFlip    → 15                                                   │
│                                                                                 │
│  TTL: 26 hours (auto-expire after session)                                      │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  PENDING EVENTS (Hash)                                                          │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  Key Pattern: {familyId}:events:pending:{eventId}                              │
│                                                                                 │
│  Fields:                                                                         │
│    eventType             → "OFI_FLIP"                                           │
│    detectedAt            → 1767981420000                                        │
│    priceAtDetection      → 295.8                                                │
│    expectedDirection     → "BULLISH"                                            │
│    confirmationCriteria  → "price > 297 within 30 min"                         │
│    expiresAt             → 1767983220000                                        │
│    status                → "PENDING"                                            │
│                                                                                 │
│  TTL: 1 hour (auto-expire if not confirmed)                                     │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  EVENT LOG (Sorted Set)                                                         │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  Key Pattern: {familyId}:events:log                                            │
│                                                                                 │
│  Members (score = timestamp):                                                   │
│    (1767981420000, "OFI_FLIP|295.8|CONFIRMED|+1.2%")                           │
│    (1767981480000, "EXHAUSTION|295.7|CONFIRMED|+0.8%")                         │
│    (1767981540000, "ST_FLIP|297.0|PENDING")                                    │
│                                                                                 │
│  Operations:                                                                     │
│    ZADD (add event)                                                             │
│    ZRANGEBYSCORE (get events in time range)                                    │
│    ZREMRANGEBYSCORE (cleanup old)                                              │
│                                                                                 │
│  TTL: None (cleanup via ZREMRANGEBYSCORE for events > 7 days old)              │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  MTF STATE (Hash)                                                               │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  Key Pattern: {familyId}:mtf                                                   │
│                                                                                 │
│  Fields:                                                                         │
│    tf_1m_bias            → "BULLISH"                                            │
│    tf_1m_confidence      → 0.85                                                 │
│    tf_5m_bias            → "BULLISH"                                            │
│    tf_15m_bias           → "NEUTRAL"                                            │
│    tf_30m_bias           → "BEARISH"                                            │
│    tf_1d_bias            → "BEARISH"                                            │
│    ltfConsensus          → "BULLISH"                                            │
│    htfConsensus          → "BEARISH"                                            │
│    alignment             → "LTF_VS_HTF_CONFLICT"                                │
│    alignmentScore        → 0.55                                                 │
│    recommendedHorizon    → "SCALP"                                              │
│    lastUpdated           → 1767981600000                                        │
│                                                                                 │
│  TTL: None (updated every candle)                                               │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
8.2 MongoDB Schema
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          MONGODB SCHEMA                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  COLLECTION: indicators_daily                                                   │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  Purpose: Pre-calculated daily indicators (computed once per day)              │
│                                                                                 │
│  {                                                                              │
│    _id: ObjectId,                                                              │
│    familyId: "NATURALGAS",                                                     │
│    symbol: "NATURALGAS",                                                       │
│    date: ISODate("2026-01-09"),                                               │
│                                                                                 │
│    pivots: {                                                                    │
│      standard: { pp, r1, r2, r3, s1, s2, s3 },                                │
│      camarilla: { r1, r2, r3, r4, s1, s2, s3, s4 },                          │
│      fibonacci: { pp, r1, r2, r3, s1, s2, s3 }                                │
│    },                                                                          │
│                                                                                 │
│    bollingerBands: {                                                            │
│      upper: 312.4,                                                             │
│      middle: 304.1,                                                            │
│      lower: 295.8,                                                             │
│      width: 0.055,                                                             │
│      previousDayClose: 312.9                                                   │
│    },                                                                          │
│                                                                                 │
│    atr: {                                                                       │
│      atr14: 8.5,                                                               │
│      atrPercent: 2.8                                                           │
│    },                                                                          │
│                                                                                 │
│    ema: {                                                                       │
│      ema9: 305.2,                                                              │
│      ema21: 308.4,                                                             │
│      ema50: 315.6,                                                             │
│      ema200: 298.2                                                             │
│    },                                                                          │
│                                                                                 │
│    fibonacci: {                                                                 │
│      swingHigh: 325.0,                                                         │
│      swingLow: 290.0,                                                          │
│      fib236: 298.3,                                                            │
│      fib382: 303.4,                                                            │
│      fib500: 307.5,                                                            │
│      fib618: 311.6,                                                            │
│      fib786: 317.5                                                             │
│    },                                                                          │
│                                                                                 │
│    previousDay: {                                                               │
│      high: 320.5,                                                              │
│      low: 305.2,                                                               │
│      close: 312.9,                                                             │
│      volume: 125000                                                            │
│    },                                                                          │
│                                                                                 │
│    calculatedAt: ISODate("2026-01-09T03:30:00Z")                              │
│  }                                                                              │
│                                                                                 │
│  Indexes:                                                                        │
│    - { familyId: 1, date: -1 } (unique)                                        │
│    - { date: -1 }                                                              │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  COLLECTION: indicators_weekly                                                  │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  Same structure as daily, calculated once per week                             │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  COLLECTION: indicators_monthly                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  Same structure as daily, calculated once per month                            │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  COLLECTION: candles_enriched                                                   │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  Purpose: Store all enriched candles for backtesting/ML                        │
│                                                                                 │
│  {                                                                              │
│    _id: ObjectId,                                                              │
│    familyId: "NATURALGAS",                                                     │
│    timeframe: "1m",                                                            │
│    timestamp: ISODate("2026-01-09T15:46:00Z"),                                │
│    windowStartMillis: 1767953760000,                                          │
│    windowEndMillis: 1767953820000,                                            │
│                                                                                 │
│    // Full enriched candle (compressed)                                         │
│    candle: { ... EnrichedFamilyCandle ... },                                   │
│                                                                                 │
│    // Key metrics extracted for querying                                        │
│    spotPrice: 296.6,                                                           │
│    ofiRegime: "BUY",                                                           │
│    gexRegime: "TRENDING",                                                      │
│    ivSkew: 0.04,                                                               │
│    mtfAlignment: "LTF_VS_HTF",                                                 │
│                                                                                 │
│    // Events in this candle                                                     │
│    events: ["evt_123", "evt_124"],                                             │
│                                                                                 │
│    // Signals generated                                                         │
│    signals: ["sig_456"],                                                       │
│                                                                                 │
│    // For ML feature extraction                                                 │
│    subsequentPrice5m: null,   // Filled async                                  │
│    subsequentPrice15m: null,                                                   │
│    subsequentPrice30m: null,                                                   │
│    subsequentPrice1h: null                                                     │
│  }                                                                              │
│                                                                                 │
│  Indexes:                                                                        │
│    - { familyId: 1, timeframe: 1, timestamp: -1 } (unique)                     │
│    - { timestamp: -1 }                                                         │
│    - { ofiRegime: 1, timestamp: -1 }                                           │
│    - { gexRegime: 1, timestamp: -1 }                                           │
│    - { "events.0": { $exists: true }, timestamp: -1 }                          │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  COLLECTION: events                                                             │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  Purpose: Store all detected events with outcomes                              │
│                                                                                 │
│  {                                                                              │
│    _id: "evt_123",                                                             │
│    familyId: "NATURALGAS",                                                     │
│    eventType: "OFI_FLIP",                                                      │
│    category: "MICROSTRUCTURE",                                                 │
│    timeframe: "1m",                                                            │
│    detectedAt: ISODate("2026-01-09T15:47:00Z"),                               │
│    priceAtDetection: 295.8,                                                    │
│                                                                                 │
│    details: {                                                                   │
│      previousOfi: -434,                                                        │
│      currentOfi: 597,                                                          │
│      flipMagnitude: 1031,                                                      │
│      zScore: 2.5                                                               │
│    },                                                                          │
│                                                                                 │
│    expectedDirection: "BULLISH",                                               │
│    status: "CONFIRMED",                                                        │
│    confirmedAt: ISODate("2026-01-09T16:10:00Z"),                              │
│                                                                                 │
│    priceAfter5m: 296.2,                                                        │
│    priceAfter15m: 297.5,                                                       │
│    priceAfter30m: 299.1,                                                       │
│    priceAfter1h: 300.5,                                                        │
│                                                                                 │
│    outcome: "SUCCESS",                                                         │
│    returnPercent: 1.6,                                                         │
│                                                                                 │
│    contextSnapshot: {                                                           │
│      bbPosition: "LOWER_BAND",                                                 │
│      stDirection: "BEARISH",                                                   │
│      gexRegime: "TRENDING",                                                    │
│      session: "MORNING_TREND",                                                 │
│      mtfAlignment: "LTF_VS_HTF"                                                │
│    }                                                                           │
│  }                                                                              │
│                                                                                 │
│  Indexes:                                                                        │
│    - { familyId: 1, detectedAt: -1 }                                           │
│    - { eventType: 1, detectedAt: -1 }                                          │
│    - { outcome: 1, eventType: 1 }                                              │
│    - { status: 1, detectedAt: -1 }                                             │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  COLLECTION: signals                                                            │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  Purpose: Store all generated signals with outcomes                            │
│                                                                                 │
│  {                                                                              │
│    _id: "sig_456",                                                             │
│    familyId: "NATURALGAS",                                                     │
│    timestamp: ISODate("2026-01-09T15:47:00Z"),                                │
│    timeframe: "1m",                                                            │
│    horizon: "SCALP",                                                           │
│    direction: "LONG",                                                          │
│    confidence: 0.82,                                                           │
│                                                                                 │
│    entryPrice: 296.2,                                                          │
│    stopLoss: 295.0,                                                            │
│    target1: 298.0,                                                             │
│    target2: 300.0,                                                             │
│    riskReward: 1.8,                                                            │
│                                                                                 │
│    supportingEvents: ["evt_123", "evt_124"],                                   │
│    entryReasons: ["OFI_FLIP", "BB_LOWER_TOUCH", "ABSORPTION"],                │
│                                                                                 │
│    modifiers: {                                                                 │
│      timeModifier: 1.0,                                                        │
│      gexModifier: 1.2,                                                         │
│      mtfModifier: 0.8                                                          │
│    },                                                                          │
│                                                                                 │
│    context: {                                                                   │
│      gexRegime: "TRENDING",                                                    │
│      session: "MORNING_TREND",                                                 │
│      mtfAlignment: "LTF_VS_HTF"                                                │
│    },                                                                          │
│                                                                                 │
│    // Outcome (filled async)                                                    │
│    actualPnlPercent: 1.2,                                                      │
│    outcome: "PROFIT",                                                          │
│    hitTarget1: true,                                                           │
│    hitTarget2: false,                                                          │
│    hitStopLoss: false                                                          │
│  }                                                                              │
│                                                                                 │
│  Indexes:                                                                        │
│    - { familyId: 1, timestamp: -1 }                                            │
│    - { horizon: 1, direction: 1, timestamp: -1 }                               │
│    - { outcome: 1, horizon: 1 }                                                │
│    - { confidence: -1, timestamp: -1 }                                         │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

SECTION 9: INTERFACE CONTRACTS
9.1 Enricher Interface
java/**
 * Base interface for all enrichers in the pipeline.
 * Each enricher adds specific context to the EnrichmentContext.
 */
public interface Enricher {

    /**
     * Unique name of this enricher for logging/metrics
     */
    String getName();

    /**
     * Order in which this enricher should run (lower = earlier)
     */
    int getOrder();

    /**
     * Whether this enricher is enabled
     */
    boolean isEnabled();

    /**
     * Perform enrichment
     *
     * @param candle The input FamilyCandle
     * @param context The enrichment context to add data to
     * @return EnrichmentResult with success/failure and any errors
     */
    EnrichmentResult enrich(FamilyCandle candle, EnrichmentContext context);

    /**
     * Dependencies on other enrichers (must run after these)
     */
    default List<String> getDependencies() {
        return Collections.emptyList();
    }
}
9.2 State Manager Interface
java/**
 * Interface for state management operations.
 * Abstracts Redis access for easier testing.
 */
public interface StateManager {

    // History operations
    List<Double> getHistory(String familyId, String timeframe, String metric);
    void updateHistory(String familyId, String timeframe, String metric, Double value);

    // Regime operations
    RegimeState getRegimeState(String familyId, String timeframe);
    void updateRegimeState(String familyId, String timeframe, RegimeState state);

    // Previous candle
    PreviousCandleData getPreviousCandle(String familyId, String timeframe);
    void updatePreviousCandle(String familyId, String timeframe, PreviousCandleData data);

    // Greeks
    GreeksSnapshot getGreeksSnapshot(String familyId);
    void updateGreeksSnapshot(String familyId, GreeksSnapshot snapshot);

    // Session
    SessionState getSessionState(String familyId, LocalDate date);
    void updateSessionState(String familyId, LocalDate date, SessionState state);

    // Events
    List<PendingEvent> getPendingEvents(String familyId);
    void savePendingEvent(String familyId, PendingEvent event);
    void updateEventStatus(String familyId, String eventId, EventStatus status);

    // MTF
    MTFState getMTFState(String familyId);
    void updateMTFState(String familyId, MTFState state);
}
```

## 9.3 Kafka Topic Contracts
```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                         KAFKA TOPIC CONTRACTS                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  TOPIC: enriched-family-candle-{tf}                                            │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  Key: String (familyId)                                                         │
│  Value: EnrichedFamilyCandle (JSON)                                            │
│  Partitions: Same as family-candle-{tf}                                        │
│  Retention: 7 days                                                              │
│  Compaction: None                                                               │
│                                                                                 │
│  TOPIC: detected-events                                                         │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  Key: String (familyId)                                                         │
│  Value: DetectedEvent (JSON)                                                    │
│  Partitions: 12                                                                 │
│  Retention: 30 days                                                             │
│  Compaction: None                                                               │
│                                                                                 │
│  TOPIC: trading-signals                                                         │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  Key: String (familyId)                                                         │
│  Value: TradingSignal (JSON)                                                    │
│  Partitions: 12                                                                 │
│  Retention: 30 days                                                             │
│  Compaction: None                                                               │
│                                                                                 │
│  TOPIC: regime-changes                                                          │
│  ─────────────────────────────────────────────────────────────────────────────  │
│  Key: String (familyId:timeframe:metricType)                                   │
│  Value: RegimeChange (JSON)                                                     │
│  Partitions: 6                                                                  │
│  Retention: 7 days                                                              │
│  Compaction: None                                                               │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘




It can enrich data and detect events, but it CANNOT:

Explain WHY price is here
Predict UPCOMING opportunities
Build a NARRATIVE from the sequence

Let me show you the gap and how to fix it:

THE GAP: NARRATIVE vs ENRICHMENT
What Current Architecture Does (Enrichment)
CANDLE ARRIVES
    ↓
"OFI = +597, regime = BUY, flip detected"
"Volume delta = +46, regime = POSITIVE"
"Absorption detected = TRUE"
"GEX regime = TRENDING"
"Near support confluence"
    ↓
SIGNAL: LONG, confidence 0.78
This answers: "WHAT is happening?"

What You Actually Need (Narrative + Prediction)
CANDLE ARRIVES
    ↓
NARRATIVE:
"Price is at 296.6 because:
 - Sellers exhausted at 295.7 (21:07) after 15 minutes of selling pressure
 - Smart money started accumulating (absorption detected 21:08-21:13)
 - Informed flow confirmed (VPIN peaked at 0.72, now declining)
 - Put writers are covering (Put OI -71, 21:13)
 - Call buyers entering (Call OI +360, accelerating)

 Price held at daily S2 (295.5) which confluences with weekly VAL (295.8)"

PREDICTION:
"Based on this sequence pattern (seen 847 times historically):
 - 73% probability: Price reaches 298.5 within 20 minutes
 - 68% probability: SuperTrend flips bullish within 25 minutes
 - Key trigger: If price crosses 297.2, gamma squeeze activates (target 302)
 - Risk: If OFI flips negative again before 297, setup invalidates"

UPCOMING OPPORTUNITIES:
1. IMMEDIATE (next 5 min): Scalp long, target 297.5, stop 295.5
2. PENDING TRIGGER: Gamma squeeze at 297.2, target 302
3. DEVELOPING: If ST flips, swing long setup forms
This answers: "WHY is price here?" + "WHAT will happen next?"

WHAT'S MISSING FROM THE ARCHITECTURE
Missing Component 1: Sequence Recognition Engine
┌─────────────────────────────────────────────────────────────────────────────────┐
│  MISSING: SEQUENCE RECOGNITION ENGINE                                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  PURPOSE:                                                                       │
│  Recognize that a SERIES of events forms a PATTERN with predictive power       │
│                                                                                 │
│  EXAMPLE SEQUENCE (from our NATURALGAS analysis):                              │
│                                                                                 │
│  Event 1: SELLING_EXHAUSTION at support                                        │
│      ↓ (1 min)                                                                  │
│  Event 2: OFI_FLIP (negative to positive)                                      │
│      ↓ (same candle)                                                            │
│  Event 3: VOLUME_DELTA_FLIP                                                     │
│      ↓ (5 min)                                                                  │
│  Event 4: PUT_OI_UNWINDING                                                      │
│      ↓ (same candle)                                                            │
│  Event 5: CALL_OI_SURGE                                                        │
│      ↓ (17 min)                                                                 │
│  Event 6: SUPERTREND_FLIP (LAGGING - this is what we PREDICT)                  │
│                                                                                 │
│  THE INSIGHT:                                                                   │
│  If we see Events 1-5, we can PREDICT Event 6 with high probability           │
│  The edge is not the SuperTrend flip - it's knowing it will flip BEFORE       │
│                                                                                 │
│  WHAT WE NEED TO BUILD:                                                        │
│                                                                                 │
│  1. SEQUENCE TEMPLATES (known predictive patterns):                            │
│     ┌─────────────────────────────────────────────────────────────────────┐    │
│     │ Template: REVERSAL_FROM_SUPPORT                                     │    │
│     │                                                                     │    │
│     │ Required Events (in order):                                         │    │
│     │   [1] EXHAUSTION at support level (within 0.5% of S/R)             │    │
│     │   [2] OFI_FLIP to positive                                          │    │
│     │   [3] VOLUME_DELTA positive OR ABSORPTION detected                  │    │
│     │                                                                     │    │
│     │ Optional Boosters:                                                  │    │
│     │   [+] PUT_OI_UNWINDING → increases probability by 15%              │    │
│     │   [+] CALL_OI_SURGE → increases probability by 12%                 │    │
│     │   [+] VPIN declining from high → increases probability by 10%      │    │
│     │                                                                     │    │
│     │ Expected Outcome:                                                   │    │
│     │   - Price increase of 0.5-1.5% within 30 minutes                   │    │
│     │   - SuperTrend flip within 15-30 minutes                           │    │
│     │                                                                     │    │
│     │ Historical Stats:                                                   │    │
│     │   - Occurred 847 times in backtest                                 │    │
│     │   - Success rate: 73%                                              │    │
│     │   - Avg gain on success: 1.2%                                      │    │
│     │   - Avg loss on failure: 0.6%                                      │    │
│     │   - Expected value: +0.72%                                         │    │
│     └─────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
│  2. SEQUENCE TRACKER (current state):                                          │
│     ┌─────────────────────────────────────────────────────────────────────┐    │
│     │ Active Sequences for NATURALGAS:                                    │    │
│     │                                                                     │    │
│     │ Sequence 1: REVERSAL_FROM_SUPPORT                                  │    │
│     │   Progress: ████████░░ 80% (4 of 5 events)                         │    │
│     │   Started: 21:07:00                                                 │    │
│     │   Events matched:                                                   │    │
│     │     ✓ SELLING_EXHAUSTION at 295.7 (21:07)                          │    │
│     │     ✓ OFI_FLIP at 295.8 (21:08)                                    │    │
│     │     ✓ ABSORPTION_DETECTED (21:08-21:13)                            │    │
│     │     ✓ PUT_OI_UNWINDING (21:13)                                     │    │
│     │   Awaiting:                                                         │    │
│     │     ○ CALL_OI_SURGE (accelerating) OR price > 297                  │    │
│     │   Current probability: 73%                                         │    │
│     │   Expected outcome: ST flip within 20 min                          │    │
│     │                                                                     │    │
│     │ Sequence 2: GAMMA_SQUEEZE_SETUP                                    │    │
│     │   Progress: ██████░░░░ 60% (3 of 5 conditions)                     │    │
│     │   Conditions met:                                                   │    │
│     │     ✓ High call OI at 300 strike                                   │    │
│     │     ✓ GEX negative at 300 strike                                   │    │
│     │     ✓ Price within 3% of strike                                    │    │
│     │   Awaiting:                                                         │    │
│     │     ○ Price momentum positive                                       │    │
│     │     ○ Price crosses 297.2 trigger                                  │    │
│     │   Trigger price: 297.2                                             │    │
│     │   Target if triggered: 302-305                                     │    │
│     └─────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
│  3. PATTERN MATCHING (real-time):                                              │
│                                                                                 │
│     On each new event:                                                          │
│       1. Check if event starts any new sequence template                       │
│       2. Check if event advances any active sequence                           │
│       3. Check if event invalidates any active sequence                        │
│       4. Update probabilities based on context                                  │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

Missing Component 2: Narrative Generator
┌─────────────────────────────────────────────────────────────────────────────────┐
│  MISSING: NARRATIVE GENERATOR                                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  PURPOSE:                                                                       │
│  Generate human-readable explanation of market state                           │
│                                                                                 │
│  INPUT:                                                                         │
│  - All enriched context (historical, technical, Greeks, events, MTF)          │
│  - Active sequences                                                             │
│  - Recent event log                                                             │
│                                                                                 │
│  OUTPUT:                                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  MarketNarrative {                                                      │   │
│  │                                                                         │   │
│  │    // WHY is price here?                                               │   │
│  │    priceExplanation: String,                                           │   │
│  │                                                                         │   │
│  │    // Recent story (last 30 min)                                       │   │
│  │    recentStory: String,                                                │   │
│  │                                                                         │   │
│  │    // Key levels in play                                               │   │
│  │    keyLevels: [                                                        │   │
│  │      { price: 295.5, type: "SUPPORT", reason: "Daily S2 + Weekly VAL" },│   │
│  │      { price: 300.0, type: "RESISTANCE", reason: "Gamma wall" }        │   │
│  │    ],                                                                   │   │
│  │                                                                         │   │
│  │    // Current regime                                                   │   │
│  │    regimeSummary: String,                                              │   │
│  │                                                                         │   │
│  │    // Who's in control                                                 │   │
│  │    controllingParty: "BUYERS" | "SELLERS" | "BALANCED",               │   │
│  │    controlEvidence: [String],                                          │   │
│  │                                                                         │   │
│  │    // Smart money activity                                             │   │
│  │    smartMoneyActivity: String,                                         │   │
│  │                                                                         │   │
│  │    // Options market telling us                                        │   │
│  │    optionsSignal: String                                               │   │
│  │  }                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  EXAMPLE OUTPUT:                                                                │
│                                                                                 │
│  priceExplanation:                                                              │
│    "NATURALGAS is at 296.6 after bouncing from support at 295.5.               │
│     The selling pressure that drove price down from 312.9 (yesterday's         │
│     close) has exhausted. Key support held - Daily S2 (295.5) confluenced      │
│     with weekly VAL (295.8) creating a strong floor."                          │
│                                                                                 │
│  recentStory:                                                                   │
│    "Over the last 25 minutes:                                                   │
│     - Price tested support at 21:07, sellers couldn't push lower               │
│     - Order flow flipped to buyers at 21:08 (OFI: -434 → +597)                │
│     - Large buyer absorbed all selling (absorption detected 21:08-21:13)       │
│     - Options market confirmed: puts being closed, calls being opened          │
│     - Price has rallied 0.3% from the low, momentum building"                  │
│                                                                                 │
│  controllingParty: "BUYERS"                                                     │
│  controlEvidence:                                                               │
│    - "OFI positive for 5 consecutive candles"                                  │
│    - "Volume delta positive and accelerating"                                  │
│    - "Absorption of selling pressure detected"                                 │
│    - "Call OI building (+360 in 5 min), Put OI declining (-71)"               │
│                                                                                 │
│  smartMoneyActivity:                                                            │
│    "Informed traders (VPIN = 0.72) were active during the bounce.              │
│     VPIN is now declining (0.72 → 0.55), suggesting informed buying            │
│     is complete. This often precedes a larger retail-driven move."             │
│                                                                                 │
│  optionsSignal:                                                                 │
│    "GEX is negative (-4.5M) indicating a TRENDING market regime.               │
│     Max pain at 305 is pulling price higher. Gamma squeeze setup               │
│     forming at 300 strike - if price crosses 297.2, dealers will               │
│     be forced to buy, accelerating the move to 302+."                          │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

Missing Component 3: Opportunity Forecaster
┌─────────────────────────────────────────────────────────────────────────────────┐
│  MISSING: OPPORTUNITY FORECASTER                                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  PURPOSE:                                                                       │
│  Predict upcoming opportunities based on current state + patterns              │
│                                                                                 │
│  OUTPUT:                                                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  OpportunityForecast {                                                  │   │
│  │                                                                         │   │
│  │    // IMMEDIATE opportunities (next 5-15 min)                          │   │
│  │    immediateOpportunities: [                                           │   │
│  │      {                                                                  │   │
│  │        type: "SCALP_LONG",                                             │   │
│  │        probability: 0.73,                                              │   │
│  │        basedOn: "REVERSAL_FROM_SUPPORT sequence 80% complete",         │   │
│  │        entry: 296.6,                                                   │   │
│  │        target: 298.5,                                                  │   │
│  │        stop: 295.5,                                                    │   │
│  │        timeframe: "15 min",                                            │   │
│  │        riskReward: 1.7,                                                │   │
│  │        confidence: "HIGH"                                              │   │
│  │      }                                                                  │   │
│  │    ],                                                                   │   │
│  │                                                                         │   │
│  │    // PENDING TRIGGERS (waiting for condition)                         │   │
│  │    pendingTriggers: [                                                  │   │
│  │      {                                                                  │   │
│  │        type: "GAMMA_SQUEEZE",                                          │   │
│  │        triggerCondition: "Price crosses 297.2",                        │   │
│  │        currentPrice: 296.6,                                            │   │
│  │        distanceToTrigger: "0.2%",                                      │   │
│  │        probabilityOfTrigger: 0.65,                                     │   │
│  │        ifTriggered: {                                                  │   │
│  │          target: 302,                                                  │   │
│  │          probability: 0.78,                                            │   │
│  │          timeframe: "30 min"                                           │   │
│  │        }                                                                │   │
│  │      },                                                                 │   │
│  │      {                                                                  │   │
│  │        type: "SUPERTREND_FLIP",                                        │   │
│  │        triggerCondition: "Price sustains above 297.5 for 2 candles",   │   │
│  │        probabilityOfTrigger: 0.68,                                     │   │
│  │        expectedTime: "15-25 min",                                      │   │
│  │        ifTriggered: {                                                  │   │
│  │          implication: "Trend confirmed bullish",                       │   │
│  │          newTarget: 305,                                               │   │
│  │          holdTime: "1-2 hours"                                         │   │
│  │        }                                                                │   │
│  │      }                                                                  │   │
│  │    ],                                                                   │   │
│  │                                                                         │   │
│  │    // DEVELOPING SETUPS (forming but not ready)                        │   │
│  │    developingSetups: [                                                 │   │
│  │      {                                                                  │   │
│  │        type: "SWING_LONG",                                             │   │
│  │        progress: "40%",                                                │   │
│  │        needsToComplete: [                                              │   │
│  │          "SuperTrend flip",                                            │   │
│  │          "15m OFI regime = BUY",                                       │   │
│  │          "Daily close above 300"                                       │   │
│  │        ],                                                               │   │
│  │        potentialTarget: 315,                                           │   │
│  │        potentialTimeframe: "2-3 days"                                  │   │
│  │      }                                                                  │   │
│  │    ],                                                                   │   │
│  │                                                                         │   │
│  │    // PREDICTED EVENTS (what we expect to happen)                      │   │
│  │    predictedEvents: [                                                  │   │
│  │      {                                                                  │   │
│  │        event: "SUPERTREND_FLIP",                                       │   │
│  │        probability: 0.68,                                              │   │
│  │        expectedIn: "15-25 min",                                        │   │
│  │        reason: "REVERSAL_FROM_SUPPORT pattern + OI confirmation"       │   │
│  │      },                                                                 │   │
│  │      {                                                                  │   │
│  │        event: "BB_MIDDLE_TEST",                                        │   │
│  │        probability: 0.72,                                              │   │
│  │        expectedIn: "20-40 min",                                        │   │
│  │        reason: "Mean reversion after lower band touch"                 │   │
│  │      }                                                                  │   │
│  │    ],                                                                   │   │
│  │                                                                         │   │
│  │    // INVALIDATION CONDITIONS (what would kill this outlook)           │   │
│  │    invalidationConditions: [                                           │   │
│  │      "OFI flips negative (below -200)",                                │   │
│  │      "Price breaks below 295.0",                                       │   │
│  │      "Call OI starts declining",                                       │   │
│  │      "VPIN spikes above 0.75 with negative OFI"                        │   │
│  │    ]                                                                    │   │
│  │  }                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

Missing Component 4: Setup Progress Tracker
┌─────────────────────────────────────────────────────────────────────────────────┐
│  MISSING: SETUP PROGRESS TRACKER                                                 │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  PURPOSE:                                                                       │
│  Track how "complete" various trading setups are                               │
│                                                                                 │
│  EXAMPLE SETUP DEFINITIONS:                                                     │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  SETUP: SCALP_REVERSAL_LONG                                            │   │
│  │                                                                         │   │
│  │  Required Conditions (need ALL):                                        │   │
│  │    □ Price at support (within 0.5% of confluence zone)                 │   │
│  │    □ OFI regime = BUY or flip detected                                 │   │
│  │    □ Volume delta > 0 or absorption detected                           │   │
│  │                                                                         │   │
│  │  Booster Conditions (nice to have):                                     │   │
│  │    □ Put OI unwinding                                                   │   │
│  │    □ Call OI building                                                   │   │
│  │    □ VPIN was high, now declining                                      │   │
│  │    □ Spread tightening (liquidity returning)                           │   │
│  │    □ GEX regime = TRENDING                                             │   │
│  │                                                                         │   │
│  │  Invalidation Conditions (any kills setup):                             │   │
│  │    ✗ Price breaks support by > 0.5%                                    │   │
│  │    ✗ OFI flips back negative                                           │   │
│  │    ✗ Spread blows out (liquidity withdrawal bearish)                   │   │
│  │                                                                         │   │
│  │  Scoring:                                                               │   │
│  │    Required conditions: 33% each (total 100%)                          │   │
│  │    Booster conditions: +5-10% each to confidence                       │   │
│  │    Base confidence at 100% = 0.65                                      │   │
│  │    Max confidence with all boosters = 0.90                             │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  CURRENT STATE EXAMPLE:                                                         │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  NATURALGAS - Active Setups                                            │   │
│  │                                                                         │   │
│  │  ┌───────────────────────────────────────────────────────────────────┐ │   │
│  │  │  SCALP_REVERSAL_LONG                                              │ │   │
│  │  │  Progress: ██████████ 100%  Confidence: 0.82                      │ │   │
│  │  │                                                                   │ │   │
│  │  │  Required:                                                        │ │   │
│  │  │    ✓ Price at support (295.7, S2 = 295.5)                        │ │   │
│  │  │    ✓ OFI regime = BUY (flipped at 21:08)                         │ │   │
│  │  │    ✓ Volume delta positive (+46)                                 │ │   │
│  │  │                                                                   │ │   │
│  │  │  Boosters:                                                        │ │   │
│  │  │    ✓ Put OI unwinding (-71) → +8%                                │ │   │
│  │  │    ✓ Call OI building (+360) → +9%                               │ │   │
│  │  │    ✓ VPIN declining (0.72 → 0.55) → +6%                          │ │   │
│  │  │    ✗ Spread: neutral                                             │ │   │
│  │  │    ✓ GEX = TRENDING → +4%                                        │ │   │
│  │  │                                                                   │ │   │
│  │  │  STATUS: READY TO TRADE                                          │ │   │
│  │  │  Entry: 296.6 | Stop: 295.0 | Target: 298.5 | RR: 1.7           │ │   │
│  │  └───────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                         │   │
│  │  ┌───────────────────────────────────────────────────────────────────┐ │   │
│  │  │  GAMMA_SQUEEZE_LONG                                               │ │   │
│  │  │  Progress: ██████░░░░ 60%   Status: PENDING TRIGGER              │ │   │
│  │  │                                                                   │ │   │
│  │  │  Required:                                                        │ │   │
│  │  │    ✓ High call OI at nearby strike (300: 4180 OI)                │ │   │
│  │  │    ✓ Negative GEX at strike (-2.5M)                              │ │   │
│  │  │    ✓ Price within 3% of strike (1.1% away)                       │ │   │
│  │  │    ✗ Price momentum positive (neutral currently)                 │ │   │
│  │  │    ✗ Price crosses trigger (need 297.2, at 296.6)                │ │   │
│  │  │                                                                   │ │   │
│  │  │  STATUS: WATCHING - need price > 297.2                           │ │   │
│  │  │  If triggered: Target 302-305                                    │ │   │
│  │  └───────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                         │   │
│  │  ┌───────────────────────────────────────────────────────────────────┐ │   │
│  │  │  SWING_LONG                                                       │ │   │
│  │  │  Progress: ████░░░░░░ 40%   Status: DEVELOPING                   │ │   │
│  │  │                                                                   │ │   │
│  │  │  Required:                                                        │ │   │
│  │  │    ✓ 1m OFI regime = BUY                                         │ │   │
│  │  │    ✗ 15m OFI regime = BUY (currently NEUTRAL)                    │ │   │
│  │  │    ✗ SuperTrend = BULLISH (currently BEARISH)                    │ │   │
│  │  │    ✗ Price above daily pivot (PP = 303.5, price = 296.6)        │ │   │
│  │  │    ✗ Daily close > 300                                           │ │   │
│  │  │                                                                   │ │   │
│  │  │  STATUS: TOO EARLY - wait for confirmation                       │ │   │
│  │  └───────────────────────────────────────────────────────────────────┘ │   │
│  │                                                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

REVISED ARCHITECTURE WITH MISSING COMPONENTS
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    COMPLETE ARCHITECTURE (REVISED)                               │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        LAYER 1: DATA CAPTURE                            │   │
│  │                        (EXISTING - No Change)                           │   │
│  │                                                                         │   │
│  │   Ticks → InstrumentCandle → FamilyCandle → family-candle-{tf}         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        LAYER 2: ENRICHMENT                              │   │
│  │                        (As Designed Above)                              │   │
│  │                                                                         │   │
│  │   TimeContext → HistoricalContext → Greeks → Technical → Confluence    │   │
│  │                                                                         │   │
│  │   OUTPUT: EnrichedFamilyCandle                                         │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        LAYER 3: EVENT DETECTION                         │   │
│  │                        (As Designed Above)                              │   │
│  │                                                                         │   │
│  │   Detect: OFI_FLIP, EXHAUSTION, ABSORPTION, ST_FLIP, etc.              │   │
│  │                                                                         │   │
│  │   OUTPUT: List<DetectedEvent>                                          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                        │
│                                        ▼                                        │
│  ══════════════════════════════════════════════════════════════════════════    │
│                              NEW LAYERS BELOW                                   │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                    LAYER 4: SEQUENCE RECOGNITION           [NEW]        │   │
│  │                                                                         │   │
│  │   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    │   │
│  │   │    Sequence     │    │    Sequence     │    │    Pattern      │    │   │
│  │   │    Templates    │    │    Tracker      │    │    Matcher      │    │   │
│  │   │                 │    │                 │    │                 │    │   │
│  │   │ • REVERSAL_LONG │    │ • Active seqs   │    │ • Match events  │    │   │
│  │   │ • REVERSAL_SHORT│    │ • Progress %    │    │ • Update seqs   │    │   │
│  │   │ • GAMMA_SQUEEZE │    │ • Probabilities │    │ • Start new     │    │   │
│  │   │ • BREAKOUT      │    │                 │    │ • Invalidate    │    │   │
│  │   │ • BREAKDOWN     │    │                 │    │                 │    │   │
│  │   └─────────────────┘    └─────────────────┘    └─────────────────┘    │   │
│  │                                                                         │   │
│  │   OUTPUT: List<ActiveSequence> with progress and probability           │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                    LAYER 5: SETUP TRACKER                  [NEW]        │   │
│  │                                                                         │   │
│  │   ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    │   │
│  │   │     Setup       │    │     Setup       │    │     Setup       │    │   │
│  │   │   Definitions   │    │     Scorer      │    │    Monitor      │    │   │
│  │   │                 │    │                 │    │                 │    │   │
│  │   │ • SCALP_LONG    │    │ • Check conds   │    │ • Track active  │    │   │
│  │   │ • SCALP_SHORT   │    │ • Calc progress │    │ • Update states │    │   │
│  │   │ • SWING_LONG    │    │ • Calc confid.  │    │ • Emit ready    │    │   │
│  │   │ • SWING_SHORT   │    │ • Apply boosts  │    │ • Invalidate    │    │   │
│  │   └─────────────────┘    └─────────────────┘    └─────────────────┘    │   │
│  │                                                                         │   │
│  │   OUTPUT: List<ActiveSetup> with progress, confidence, status          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                    LAYER 6: NARRATIVE GENERATOR            [NEW]        │   │
│  │                                                                         │   │
│  │   INPUT: All enriched data + events + sequences + setups               │   │
│  │                                                                         │   │
│  │   GENERATES:                                                            │   │
│  │   • priceExplanation: WHY is price here?                               │   │
│  │   • recentStory: What happened in last 30 min?                         │   │
│  │   • controllingParty: Who's winning? (buyers/sellers)                  │   │
│  │   • smartMoneyActivity: What are informed traders doing?               │   │
│  │   • optionsSignal: What is options market saying?                      │   │
│  │   • keyLevels: What levels matter and why?                             │   │
│  │                                                                         │   │
│  │   OUTPUT: MarketNarrative                                              │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                    LAYER 7: OPPORTUNITY FORECASTER         [NEW]        │   │
│  │                                                                         │   │
│  │   INPUT: Sequences + Setups + Historical pattern outcomes              │   │
│  │                                                                         │   │
│  │   GENERATES:                                                            │   │
│  │   • immediateOpportunities: Ready to trade NOW                         │   │
│  │   • pendingTriggers: What we're watching for                           │   │
│  │   • developingSetups: What's forming                                   │   │
│  │   • predictedEvents: What we expect to happen                          │   │
│  │   • invalidationConditions: What kills the outlook                     │   │
│  │                                                                         │   │
│  │   OUTPUT: OpportunityForecast                                          │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                    LAYER 8: SIGNAL GENERATOR                            │   │
│  │                    (Enhanced from original design)                      │   │
│  │                                                                         │   │
│  │   INPUT: All layers above                                               │   │
│  │                                                                         │   │
│  │   Enhanced Signal includes:                                             │   │
│  │   • Standard: entry, stop, target, confidence                          │   │
│  │   • NEW: narrative (why this signal?)                                  │   │
│  │   • NEW: sequence_basis (which pattern?)                               │   │
│  │   • NEW: predicted_events (what should happen next?)                   │   │
│  │   • NEW: invalidation_watch (what to monitor?)                         │   │
│  │                                                                         │   │
│  │   OUTPUT: TradingSignal (enhanced)                                     │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                        │                                        │
│                                        ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        OUTPUT TOPICS                                    │   │
│  │                                                                         │   │
│  │   enriched-family-candle-{tf}  - Full enriched data                    │   │
│  │   detected-events              - Individual events                      │   │
│  │   active-sequences             - Pattern progress          [NEW]       │   │
│  │   active-setups                - Setup progress            [NEW]       │   │
│  │   market-narrative             - Human-readable story      [NEW]       │   │
│  │   opportunity-forecast         - Predictions               [NEW]       │   │
│  │   trading-signals              - Actionable signals                    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

FINAL OUTPUT: WHAT THE SYSTEM PRODUCES
For NATURALGAS at 21:13:00 on 2026-01-09, the system would produce:
┌─────────────────────────────────────────────────────────────────────────────────┐
│  NATURALGAS MARKET INTELLIGENCE REPORT                                           │
│  Time: 21:13:00 | Price: 296.6 | Timeframe: 1m                                  │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  WHY IS PRICE HERE?                                                             │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  Price is at 296.6 after bouncing from support at 295.5. The selling           │
│  pressure that drove price down from 312.9 has exhausted. Key support          │
│  held - Daily S2 (295.5) confluenced with weekly VAL (295.8).                  │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  WHAT HAPPENED (Last 25 min)                                                    │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  21:07 - Sellers exhausted at support (OFI velocity turning positive)          │
│  21:08 - Order flow flipped to buyers (OFI: -434 → +597)                       │
│  21:08 - Large buyer started absorbing selling pressure                         │
│  21:13 - Put writers covering (-71 OI), Call buyers entering (+360 OI)         │
│  21:13 - Price rallied 0.3% from low, momentum building                        │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  WHO'S IN CONTROL?                                                              │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  BUYERS ████████░░ (Strong)                                                    │
│                                                                                 │
│  Evidence:                                                                       │
│  ✓ OFI positive for 5 consecutive candles                                      │
│  ✓ Volume delta positive and accelerating                                      │
│  ✓ Absorption of selling pressure detected                                     │
│  ✓ Call OI building, Put OI declining                                          │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  ACTIVE PATTERN: REVERSAL_FROM_SUPPORT                                          │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  Progress: ████████░░ 80%                                                      │
│  Probability of success: 73%                                                    │
│  Historical win rate: 73% (847 occurrences)                                    │
│                                                                                 │
│  Events completed:                                                               │
│  ✓ SELLING_EXHAUSTION at support                                               │
│  ✓ OFI_FLIP (bearish to bullish)                                               │
│  ✓ ABSORPTION detected                                                          │
│  ✓ PUT_OI_UNWINDING                                                             │
│  ○ CALL_OI_SURGE (in progress, +360 so far)                                    │
│                                                                                 │
│  Expected next: SUPERTREND_FLIP within 15-25 minutes                           │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  READY SETUPS                                                                   │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  SCALP LONG - READY                                                     │   │
│  │  Confidence: 82%                                                        │   │
│  │                                                                         │   │
│  │  Entry: 296.6 (current price)                                          │   │
│  │  Stop: 295.0 (below support confluence)                                │   │
│  │  Target 1: 298.5 (measured move)                                       │   │
│  │  Target 2: 300.0 (gamma wall)                                          │   │
│  │  Risk:Reward: 1.7                                                      │   │
│  │                                                                         │   │
│  │  WHY: REVERSAL_FROM_SUPPORT pattern 80% complete, OI confirms,         │   │
│  │       GEX regime = TRENDING (breakouts work), prime session            │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  PENDING TRIGGERS                                                               │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  GAMMA SQUEEZE                                                          │   │
│  │  Trigger: Price crosses 297.2                                          │   │
│  │  Current: 296.6 (0.2% away)                                            │   │
│  │  Probability of trigger: 65%                                           │   │
│  │                                                                         │   │
│  │  IF TRIGGERED:                                                          │   │
│  │  → Dealers forced to buy (short gamma at 300 strike)                   │   │
│  │  → Target: 302-305                                                     │   │
│  │  → Timeframe: 30 min                                                   │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │  SUPERTREND FLIP                                                        │   │
│  │  Expected in: 15-25 min                                                │   │
│  │  Probability: 68%                                                      │   │
│  │                                                                         │   │
│  │  IF FLIPPED:                                                            │   │
│  │  → Trend confirmed bullish                                             │   │
│  │  → SWING_LONG setup activates                                          │   │
│  │  → New target: 305+                                                    │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
│                                                                                 │
│  ══════════════════════════════════════════════════════════════════════════    │
│  WHAT WOULD INVALIDATE THIS?                                                    │
│  ══════════════════════════════════════════════════════════════════════════    │
│                                                                                 │
│  ✗ OFI flips negative (below -200)                                             │
│  ✗ Price breaks below 295.0                                                    │
│  ✗ Call OI starts declining                                                    │
│  ✗ VPIN spikes above 0.75 with bearish flow                                    │
│                                                                                 │
│  If any of the above occur, EXIT and reassess.                                 │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

ANSWER TO YOUR QUESTION
YES, with the additional 4 components (Sequence Recognition, Setup Tracker, Narrative Generator, Opportunity Forecaster), the system CAN:

✅ Explain WHY price is here
✅ Show what happened and who's in control
✅ Identify patterns/sequences in progress
✅ Track setup progress with confidence scores
✅ Predict upcoming events and opportunities
✅ Define clear invalidation conditions
✅ Generate actionable signals with context

The original architecture was ENRICHMENT only. We need to add INTELLIGENCE on top.

UPDATED MODULE LIST
ModuleStatusPurposeM-01 to M-46As designedEnrichment layerM-47: SequenceTemplateRegistryNEWDefine known patternsM-48: SequenceTrackerNEWTrack active sequencesM-49: PatternMatcherNEWMatch events to sequencesM-50: SetupDefinitionRegistryNEWDefine trading setupsM-51: SetupScorerNEWCalculate setup progressM-52: SetupMonitorNEWTrack active setupsM-53: NarrativeGeneratorNEWGenerate market storyM-54: OpportunityForecasterNEWPredict opportunities